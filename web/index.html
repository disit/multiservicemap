<!DOCTYPE html>
<html>
<head>
    <title>MultiServiceMap</title>
    <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
    <link rel="stylesheet" href="css/leaflet-gps.css" type="text/css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
        integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
        crossorigin=""></script>
    <!--<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>-->
    <script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="https://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
    <!--<script src="http://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>-->
    <script src="https://code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/highcharts-3d.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css" />
    <link rel="stylesheet" href="css/leaflet.awesome-markers.css">
    <script src="js/leaflet.awesome-markers.min.js"></script>
    <script src="js/jquery.dialogextend.js"></script>
    <script src="js/leaflet-gps.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="js/mustache.js"></script>
    <script src="js/mustache.min.js"></script>
    <script src="js/ViewManager.js"></script>
    <script src="js/jquery.dataTables.min.js"></script>
    <script src="js/moment.min.js"></script>
    <script src="js/datetime-moment.js"></script>
    <script src="js/jquery.timepicker.min.js"></script>
    <script src="js/zoomHandler.js"></script>

    <script src="js/oms.min.js"></script>
    <!-- code per gallery -->
    <script type="text/javascript" src="fancybox/lib/jquery.mousewheel-3.0.6.pack.js"></script>
    <link rel="stylesheet" href="fancybox/source/jquery.fancybox.css" type="text/css" media="screen" />
    <script type="text/javascript" src="fancybox/source/jquery.fancybox.pack.js"></script>
    <link rel="stylesheet" href="fancybox/source/helpers/jquery.fancybox-buttons.css" type="text/css" media="screen" />
    <script type="text/javascript" src="fancybox/source/helpers/jquery.fancybox-buttons.js"></script>
    <script type="text/javascript" src="fancybox/source/helpers/jquery.fancybox-media.js"></script>
    <script src="js/wicket.js"></script>
    <script src="js/wicket-leaflet.js"></script>
    <!--  CARICAMENTO DEL FILE utility.js CON FUNZIONI NECESSARIE  -->
    <script type="text/javascript" charset="utf-8" src="js/utility.js?force=a"></script>
    <script type="text/javascript" src="js/pathsearch.js"></script>
    <script type="text/javascript" src="js/save_embed.js"></script>

    <link rel="stylesheet" href="fancybox/source/helpers/jquery.fancybox-thumbs.css" type="text/css" media="screen" />
    <script type="text/javascript" src="fancybox/source/helpers/jquery.fancybox-thumbs.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"
        type="text/css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"
        type="text/css" />
    <link rel="stylesheet" href="css/style.css" type="text/css" />
    <link rel="stylesheet" href="css/jquery.dataTables.min.css" type="text/css" />
    <link rel="stylesheet" href="css/jquery.timepicker.min.css" type="text/css" />

    <!--  Ala's stuff  -->
    <script type="text/javascript" src="js/Authentication.js"></script>
    <!-- <script type="text/javascript" src="js/Globalization.js"></script> -->
    <script type="text/javascript" src="js/Keycloak.js"></script>
    <script type="text/javascript" src="conf/config.json"></script>
    <script type="text/javascript" src="conf/platforms.json"></script>
    <!-- <script type="text/javascript" src="path-to/bower_components/crypto-js/crypto-js.js"></script> -->
    <!-- <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/md5.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/md5.js"></script>
    <script src="https://www.myersdaily.org/joseph/javascript/md5.js"></script>
    <script src="https://requirejs.org/docs/release/2.3.5/minified/require.js"></script>
    <link rel="stylesheet" type="text/css"  href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch-theme-algolia.min.css"/>
</head>

<body class="Chrome" onload="">

    <script>
        let showPosition=true;
        let showVehiclePositionButtonPressed=false;
        let superServiceMapApiUrl = "";
        let selectedorgUrl = superServiceMapApiUrl;
        var listOfPopUpOpen = [];
        let natureApiUrl = "";
        let subnatureApiUrl = "";
        let orgApiUrl = "";
        let multiServiceMapUrl="";
        let realm="";
        let authUrl="";
        let clientId="";
        let ldapApiUrl="";
        let orgs=[];
        let platform_orgApiUrls=[];
        let orgApiUrls=[];
        let orgCenterLatLng=[];
        let orgZoomLevel=[];
        let platform_orgZoomLevel=[];
        let adressSearchText="";
        const checkedFiles=new Map();
        let textFilter = "";
        let serviceModel = "";
        let value_type="";

        //events (to be retireved when events are going to be saved (save_embed.js))
        let eventRange="";
        let eventRaggioRic="";
        let eventcentroRic="";
        let eventNumEv="";
        let eventText="";
        let org="";

        function loadConfigJSON(callback) {
            var xobj = new XMLHttpRequest();
            xobj.overrideMimeType("application/json");
            xobj.open('GET', 'conf/config.json', false); // Replace 'my_data' with the path to your file
            xobj.onreadystatechange = function () {
                if (xobj.readyState == 4 && xobj.status == "200") {
                    // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
                    callback(xobj);
                }
            };
            xobj.send(null);
        }

        loadConfigJSON(function (response) {
                    // preserve newlines, etc - use valid JSON
                    s = response.response.replace(/\\n/g, "\\n")
                        .replace(/\\'/g, "\\'")
                        .replace(/\\"/g, '\\"')
                        .replace(/\\&/g, "\\&")
                        .replace(/\\r/g, "\\r")
                        .replace(/\\t/g, "\\t")
                        .replace(/\\b/g, "\\b")
                        .replace(/\\f/g, "\\f");
                    // remove non-printable and other non-valid JSON chars
                    s = s.replace(/[\u0000-\u0019]+/g, "");
                    // Changing string data into JSON Object
                    config_obj = JSON.parse(s)[0];
                    
                    natureApiUrl = `${config_obj.natureApiUrl}`;
                    subnatureApiUrl = `${config_obj.subnatureApiUrl}`;
                    orgApiUrl = `${config_obj.orgApiUrl}`;
                    superServiceMapApiUrl = `${config_obj.superServiceMapApiUrl}`;
                    selectedorgUrl=superServiceMapApiUrl;
                    multiServiceMapUrl=`${config_obj.multiServiceMapUrl}`;
                    realm = `${config_obj.realm}`;
                    authUrl = `${config_obj.authUrl}`;
                    clientId = `${config_obj.clientId}`;
                    ldapApiUrl = `${config_obj.ldapApiUrl}`;
        });

        (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
        ga('create', 'UA-64916363-1', 'auto');
        ga('send', 'pageview');

        var mode = "query";
        var api = "";
        window.configurationData = {};
        window.configurationData.enableSensorValidation = "true";
        window.configurationData.sensorValidationUrl = "https://www.snap4city.org/sensor-validate/";

    </script>


    <div id="dialog"></div>
    <div id="map">
        <div class="menu" id="help">
            <a href="http://www.disit.org/servicemap" title="Aiuto Service Map" target="_blank"><img src="img/help.png"
                    alt="help SiiMobility ServiceMap" width="28" /></a>
        </div>
    </div>
    <select id="org_selector" style="position: absolute;left: 43%;z-index: 1001;top: 5px;font-size: 16px;">
    <!-- <option value="null"> - Select an Organization -</option> -->
    </select>

    <div class="menu" id="save">
        <img  src="img/save.png" alt="Salva la configurazione" width="28" 
            onclick="save_handler(null, null, null, true);" />
    </div>
    <div class="menu" id="embed">
        <img src="img/embed_icon.png" alt="Embed Service Map" width="28" onclick="embedConfiguration();" />
    </div>
    <div id="menu-alto-hidden" class="menu-logo">
        <div id="siiMob"> <a href="http://km4city.org" target="_blank"><img src="img/km4city.png" height="28"
                    margin-left="15px" alt="KM4City"> </a></div>
        <div id="km4city"> <a href="http://www.sii-mobility.org" target="_blank"><img src="img/SiiMobility_logo.png"
                    width="60" alt="SiiMobility"></a></div>
    </div>

    <div id="menu-alto" class="menu">
        <div id="lang" value="ENG"><img width="40" id="icon_lang" src="img/icon_ITA.png"
                onclick="changeLanguage('ITA')"></div>
        <div id="siiMob"> <a href="http://km4city.org" target="_blank"><img src="img/km4city.png" height="28"
                    margin-left="15px" alt="KM4City"> </a></div>
        <div id="km4city"> <a href="http://www.sii-mobility.org" target="_blank"><img src="img/SiiMobility_logo.png"
                    width="60" alt="SiiMobility"> </a></div>

        <!--
            <a href="http://www.google.com" target="_blank"> 
                <img width="40" height="40" border="0" align="center"  src="img/embed_icon.png" /> 
            </a>-->
        <div class="header-container">
            <div class="header">
                <span name="lbl" caption="Hide_Menu_sx"> - Hide Menu</span>
            </div>
        </div>
        <div class="content" id="content_div" style="padding: 5px;">
            <div id="tabs">
                <ul>
                    <li><a href="#tabs-1"><span name="lbl" caption="Bus_Search">Public Transport</span></a></li>
                    <li><a href="#tabs-2"><span name="lbl" caption="Municipality_Search">Municipalities</span></a></li>
                    <li><a href="#tabs-search"><span name="lbl" caption="Text_Search">Text Search</span></a></li>
                    <li><a href="#tabs-addr-search"><span name="lbl" caption="Text_AddrSearch">Address Search</span></a></li>
                    <li><a href="#tabs-Event"><span name="lbl" caption="Event_Search">Events</span></a></li>
                </ul>
                <div id="tabs-1">
                    <div class="use-case-1">
                        <span name="lbl" caption="Select_Agency">Select an agency</span>:
                        <br />
                        <select id="elencoagenzie" name="elencoagenzie" onchange="mostraElencoLinee(this);"></select>
                        <br />
                        <span name="lbl" caption="Select_Line">Select a Line</span>:
                        <br />
                        <!--<select id="elencolinee" name="elencolinee" onchange="mostraElencoFermate(this);"> </select>-->
                        <select id="elencolinee" name="elencolinee" onchange="mostraElencoPercorsi(this);">
                            <option value=""> - Select a Line -</option>
                        </select>
                        <br />
                        <span name="lbl" caption="Select_Route">Select a route</span>:
                        <br />
                        <!--<select id="elencopercorsi" name="elencopercorsi" onchange="mostraElencoPercorsi(this);"></select>-->
                        <select id="elencopercorsi" name="elencopercorsi" onchange="mostraElencoFermate(this);">
                            <option value=""> - Select a Route -</option>
                        </select>
                        <br />
                        <span name="lbl" caption="Select_BusStop">Select a Stop</span>:
                        <br />
                        <select id="elencofermate" name="elencofermate" onchange="mostraFermate(this);">
                            <option value=""> - Select a Stop - </option>
                        </select>
                            <div>
                                <div style="overflow: hidden; ">
                                <div id="pulsanteRT" name="autobusRealTime" onclick="showVehiclePosition(true);">
                                    <span id="vehicle_position" name="lbl" caption="Position_Bus">Show the Position of Vehicles</span>
                                </div>
                                <div id="stop_show_position" name="stop_show_position" onclick="stopShowPositions(true);">
                                <span name="lbl" caption="Stop_Show_Position" style="width: 290px;">Stop!</span>
                                </div>
                                </div>
                                <input id="savePositionBus" class="save_disk" type="image" src="img/save_disable.png" alt="Salva la query" width="30px" style="cursor: default;    float: right;
                                position: relative;top: -25px;" onclick="save_handler('Position_Bus', null, null, false, '');" disabled="">
                               
                            </div>
                    </div>
                </div>
                <div id="tabs-2">
                    <div class="use-case-2">
                        <span name="lbl" caption="Select_Province">Select a province</span>:
                        <br />
                        <select id="elencoprovince" name="elencoprovince" onchange="mostraElencoComuni(this);">
                            <option value=""> - Select a Province - </option>
                            <option value="all">ALL THE PROVINCES</option>
                            <option disabled>--TOSCANA----------</option>
                            <option value="Arezzo">AREZZO</option>
                            <option value="Firenze">FIRENZE</option>
                            <option value="Grosseto">GROSSETO</option>
                            <option value="Livorno">LIVORNO</option>
                            <option value="Lucca">LUCCA</option>
                            <option value="Massa Carrara">MASSA-CARRARA</option>
                            <option value="Pisa">PISA</option>
                            <option value="Pistoia">PISTOIA</option>
                            <option value="Prato">PRATO</option>
                            <option value="Siena">SIENA</option>
                            <option disabled>--SARDEGNA---------</option>
                            <option value="Cagliari">CAGLIARI</option>
                        </select>
                        <br />
                        <span name="lbl" caption="Select_Municipality">Select a municipality</span>:
                        <br />
                        <select id="elencocomuni" name="elencocomuni" onchange="updateSelection();
                                    ">
                            <option value=""> - Select a Municipality - </option>
                        </select>
                    </div>
                </div>
                <div id="tabs-search">
                    <div class="use-case-search"><span name="lbl" caption="Select_Text_sx">Search by Text</span>:
                        <input type="text" name="search" id="freeSearch"
                            onkeypress="event.keyCode == 13 ? searchText() : false">
                        <br><br><span name="lbl" caption="Num_Results_sx">Max number of results</span>:
                        <select id="numberResults" name="numberResults">
                            <option value="100">100</option>
                            <option value="200">200</option>
                            <option value="500">500</option>
                            <option value="0">No limit</option>
                        </select>
                        <div class="menu" id="serviceTextSearch"  style="left: 315px;top: 37px;">
                            <img src="img/search_icon.png" alt="Search Services" width="24" onclick="searchText();">
                        </div>
                        <div class="menu" id="saveQuerySearch"  style="left: 502px;top: 72px;width: 36px;">
                            <!-- <img src="img/save.png" alt="Salva la query" width="28"
                                onclick="save_handler(null, null, null, false, 'freeText');" /> -->
                                <input id="saveTextSearch" class="save_disk" type="image" src="img/save_disable.png" alt="Salva la query" width="30px" style="cursor: default;" onclick="save_handler(null, null, null, false, 'freeText');">
                        </div>
                        <!--<fieldset id="address-selection" style="margin-top:10px"> 
                                <legend><span name="lbl" caption="">Quick address/location search</span></legend>
                                exclude POI:<input type="checkbox" id="quick-search-poi">
                                AND mode:<input type="checkbox" id="quick-search-and">
                                <input id="quick-search" >
                            </fieldset>-->
                    </div>
                </div>
                <div id="tabs-addr-search">
                    <div class="use-case-addr-search">
                        <label style="position: relative;left: 20px;">Exclude POI:</label><input type="checkbox"
                            id="quick-search-poi" style="position: relative;left: 20px;">
                        <label style="position: relative;left: 60px;">AND mode:</label> <input type="checkbox"
                            checked="checked" id="quick-search-and" style="position: relative;left: 60px;">
                        <label style="position: relative;left: 110px;">Sort by distance:</label><input type="checkbox"
                            checked="checked" id="quick-search-sortdist" style="position: relative;left: 110px;"><br>
                        Position:<input id="quick-search-position"
                            style="margin-top: 15px;margin-bottom: 5px;left: 18px;position: relative;" value=""><label
                            style="position: relative;left: 20px;">(lat;lon e.g., 43.7869;11.2719)</label><br>
                        maxDists:<input id="quick-search-maxdists"
                            style="margin-top: 5px;margin-bottom: 5px;left: 9px;position: relative;" value=""><label
                            style="position: relative;left: 10px;">(in km)</label><br>
                        Categories:<input id="quick-search-categories" style="margin-top: 5px;margin-bottom: 5px;"
                            value="BusStop;StreetNumber;Municipality"><br>
                        Address:<input id="quick-search" style="width: 75%;position: relative;left: 17px;margin-top: 17px;">
                        <input id="saveAddressSearch" class="save_disk" type="image" src="img/save_disable.png" alt="Salva la query" width="28" style="cursor: default;position: relative;top: 10px;
                        left: 20px;" onclick="save_handler('address', null, null, false, null);">
                    </div>
                </div>
                <div id="tabs-Event" style="padding-top:10px;">
                    <span name="lbl" caption="Select_Time">Select a time interval: </span>
                    <input type="radio" id="event_choice_d" name="event_choice" value="day"
                        onchange="searchEvent(this.value, null, null)"><span name="lbl" caption="Day">Day</span>
                    <input type="radio" id="event_choice_w" name="event_choice" value="week"
                        onchange="searchEvent(this.value, null, null)"><span name="lbl"
                        caption="Week">Week</span>
                    <input type="radio" id="event_choice_m" name="event_choice" value="month"
                        onchange="searchEvent(this.value, null, null)"><span name="lbl"
                        caption="Month">Month</span>
                    
                    <input id="saveEventSearch" class="save_disk" type="image" src="img/save_disable.png" alt="Salva la query" width="28" style="cursor: default;" onclick="save_handler('event', null, null, false, null);">
                    
                    <fieldset id="event">
                        
                        <legend><span name="lbl" caption="Event_Florence">Events in Florence</span></legend>
                        <div id="eventNum" style="display:none;"></div>
                        <div id="eventList"></div>
                    </fieldset>
                </div>
                <!--  
                    <div id="tabs-Event" style="padding-top:10px;">
                        <div id="event_radio">
                        <span name="lbl" caption="Select_Time">Select a time interval: </span>
                        <input type="radio" id= "event_choice" name="event_choice" value="day" ><span name="lbl" caption="Day">Day</span></input>
                        <input type="radio" id= "event_choice" name="event_choice" value="week" ><span name="lbl" caption="Week">Week</span></input>
                        <input type="radio" id= "event_choice" name="event_choice" value="month" ><span name="lbl" caption="Month">Month</span></input>
                        </div>
                        <img id="EventSearch" src="img/search_icon.png" alt="Salva la query" width="28" onclick="searchEvent($(#event_radio).value), null, null)" />
                        <img id="saveEventSearch" src="img/save.png" alt="Salva la query" width="28" onclick="save_handler('event', null, null, false, null);" />
                        <fieldset id="event"> 
                            <legend><span name="lbl" caption="Event_Florence">Events in Florence</span></legend>
                            <div id="eventNum" style="display:none;"></div>
                            <div id="eventList"></div>
                        </fieldset>
                    -->
            </div>
            <fieldset id="selection" style="width: 94%;position: relative;top: -10px;">
                <legend><span name="lbl" caption="Actual_Selection">Actual Selection</span></legend>
                <span id="selezione">No selection</span> <br>
                <div id="approximativeAddress"></div>
            </fieldset>
            <fieldset id="path" style="display:none;">
                <legend><span name="lbl" caption="Path">Path</span></legend>
                <div id="path_start">From: ?</div>
                <div id="path_end">To: ?</div>
                Route via: <select id="path_type" style="margin-top: 5px;">
                    <option value="foot_shortest">foot_shortest</option>
                    <option value="foot_quiet">foot_quiet</option>
                    <option value="car">car</option>
                    <option value="public_transport">public_transport</option>
                </select><br>
                Start date&amp;time: <input type="text" id="path_date" style="margin-top: 5px;" placeholder="today" maxlength="10" />
                <input type="text" id="path_time" placeholder="now" max length="10" /><br>
                <button style="margin:10px 0px;" onclick="doSearchPath()">Search Path</button>
                <input id="savePathSearch" class="save_disk" type="image" src="img/save_disable.png" alt="Salva la query" width="28" style="cursor: pointer; position: relative; top: 10px; left: 360px;" onclick="save_handler('path', null, null, false, null);">
                <!-- <hr> -->
                <div id="pathresult" style="max-height:250px;overflow:auto;"></div>
            </fieldset>
            <!-- <div id="queryBox">
                <hr>
                <h2>A query</h2>
                <p>No description provided.</p>
            </div> -->
        </div>
    </div>
    <!-- </div> -->
    <div id="loading">
        <div id="messaggio-loading">
            <img src="img/ajax-loader.gif" width="32" />
            <h3>Loading...</h3>
            <span name="lbl" caption="Loading_Message">Loading may take time</span>
        </div>
    </div>
    <div id="serviceMap_query_toggle"></div>

    <div id="menu-dx" class="menu">

        <div class="header">
            <span name="lbl" caption="Hide_Menu_sx"> - Hide Menu</span></div>
        <div class="content">
            <div class="content" style="position: relative; top: -15px;">
                <div id="login_div" style="padding-bottom: 10px;padding-left: 30px;height: 50px;position: relative;left: 0px;border-style: solid;border-width: 2px;"> 
                    <div id="login" style="position: absolute;left: 112px;top: 0px;padding-top: 5px;">
                        <button type="button" id="mainMenuUsrLoginBtn" class="editDashBtn" style="z-index:1001; background: #39a25a;height: 20px;background-color: rgb(69, 183, 175);border: none;color: white;text-transform: uppercase;-webkit-appearance: button;cursor: pointer;overflow: visible;margin: 0; font: inherit;-webkit-font-smoothing: antialiased;box-sizing: border-box;letter-spacing: normal;word-spacing: normal;text-indent: 0px;text-shadow: none;display: inline-block;text-align: center;align-items: flex-start; padding: 1px 6px; position: relative;font-weight: bold;" onclick="check_token();">login</button>
                    </div>
                    <div id="userPass" style="position: relative;padding-top: 40px;left: -48px;overflow: hidden;text-align: center;width: 320px;font-size: 10px;">
                       
                            <span name="lbl" caption="username" id="span_username" style="text-transform: uppercase;">Username: -</span>
                          
                            <span name="lbl" caption="username" id="span_org" style="text-transform: uppercase;">, Org: -</span>
                          
                    </div>
                </div>
                <input type="text" id="search-categories" placeholder="Search Categories.." style="width:100%;margin-top: 5px;position: relative;left: -5px;">
            </div>

            <div id="tabs-servizi" class="ui-tabs ui-widget ui-widget-content ui-corner-all" style="position: relative;top: -20px;">
                <ul class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all"
                    role="tablist">
                    <li onclick="document.getElementById('transversal_services_div').style.display='none';"
                        class="ui-state-default ui-corner-top ui-tabs-active ui-state-active" role="tab" tabindex="0"
                        aria-controls="tabs-4" aria-labelledby="ui-id-6" aria-selected="true" aria-expanded="true"><a
                            href="#tabs-4" class="ui-tabs-anchor" role="presentation" tabindex="-1" id="ui-id-6"><span
                                name="lbl" caption="Search_Regular_Services">Regular Services</span></a></li>
                    <li onclick="document.getElementById('transversal_services_div').style.display='block';"
                        class="ui-state-default ui-corner-top" role="tab" tabindex="-1" aria-controls="tabs-5"
                        aria-labelledby="ui-id-7" aria-selected="false" aria-expanded="false" style="display: block;position: relative;"><a
                            href="#tabs-5" class="ui-tabs-anchor" role="presentation" tabindex="-1" id="ui-id-7"><span
                                name="lbl" caption="Search_Transversal_Services">Transversal Services</span></a></li>
                    <!-- <li><a href="#tree"><span name="lbl" caption="Search_Services">Test Tree Services</span></a></li> -->

                </ul>
                <div id="tabs-4" aria-labelledby="ui-id-6" class="ui-tabs-panel ui-widget-content ui-corner-bottom"
                    role="tabpanel" aria-hidden="false" style="display: block;overflow: hidden;min-height: 655px">
                    <div class="use-case-4">
                        <!-- <span name="lbl" caption="Services_Categories_R">Services Categories</span>
                        <br> -->
                        <input type="checkbox" name="macro-select-all" id="macro-select-all" value="Select All"> <span
                            name="lbl" caption="Select_All_R">De/Select All</span>
                        <div id="categorie"></div>
                        <hr>
                    </div>
                  <div>

                    <div class="menu" id="serviceSearch">
                        <img src="img/search_icon.png" alt="Search Services" width="24" onclick="ricercaServizi('categorie', null, null);">
                    </div>
                    <div class="menu" id="serviceSearchChart" style="display: none;">
                        <img src="img/search_chart.png" alt="Search Chart" width="24"
                            onclick="showChart(selezione, $('#raggioricerca').val(), coordinateSelezione);">
                    </div>
                    <div class="menu" id="clearAll">
                        <img src="img/clear_icon.png" alt="Clear all" width="28" onclick="resetTotale();">
                    </div>
                    <div id="chart_dialog" title="Query results organized by category">
                        <p></p>
                        <div id="chart_container"></div>
                    </div>
                    <div class="menu" id="saveQuery">
                        <input id="save_disc_regular" class="save_disk" type="image" src="img/save_disable.png" alt="Salva la query" width="28" style="cursor: default;" onclick="save_handler();">
                        <!-- <img src="img/save.png" alt="Salva la query" width="28" onclick="save_handler();"> -->
                    </div><br><br>
                    <hr>
                  </div>
                    
                    <div>
                    <!-- <span name="lbl" caption="Filter_Results_dx_R">Model:</span> -->
                    <fieldset>
                        <legend><span name="lbl" caption="additional filters">Additional Filters</span></legend>
                    <input type="text" name="serviceModel" id="serviceModel" placeholder="Service Model"
                        style="width: 98%;margin-bottom: 5px;">
                    <br>
                    <!-- <span name="lbl" caption="Filter_Results_dx_R">Filter</span>: -->
                    <input type="text" name="serviceTextFilter" id="serviceTextFilter"
                        placeholder="search text into service"  style="width: 98%;"
                        onkeypress="event.keyCode == 13 ? ricercaServizi('categorie', null, null) : false"><br>
                   Value Type<select id="valueTypeFilter" name="valueTypeFilter" style="margin-left: 23px;">
                        <option value="">select</option>
                        <option>BC_concentration</option>
                        <option>CO2_concentration</option>
                    </select><br>
                    <span name="lbl" caption="Num_Results_dx_R">N. results</span>
                    <select id="nResultsServizi" name="nResultsServizi" style="margin-top: 5px;margin-left: 27px;margin-bottom: 5px;">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100" selected="selected">100</option>
                        <option value="200">200</option>
                        <option value="500">500</option>
                        <option value="0">No Limit</option>
                    </select>
                    <br>
                    
                    <span name="lbl" caption="Search_Range_R">Search range</span>
                    <select id="raggioricerca" name="raggioricerca">
                        <option value="0.1">100 mt</option>
                        <option value="0.2">200 mt</option>
                        <option value="0.3">300 mt</option>
                        <option value="0.5">500 mt</option>
                        <option value="1">1 km</option>
                        <option value="2">2 km</option>
                        <option value="5">5 km</option>
                        <option value="10">10 km</option>
                        <option value="area" selected="selected">visible area</option>
                        <!-- <option value="geo">specific area</option> -->
                        <option value="inside">inside</option>
                    </select><br>
                    <span name="lbl" caption="Search_Area_R">Search area</span>
                    <select id="geosearch" name="geosearch" disabled="disabled" style="    margin-top: 5px;
                    margin-left: 9px;">
                        <option value="select">select...</option>
                        <option value="area near fortezza">area near fortezza</option>
                        <option value="ATAF 17B">ATAF 17B</option>
                        <option value="ATAF 4">ATAF 4</option>
                        <option value="ZCS4D">ZCS4D</option>
                        <option value="ZCS5D">ZCS5D</option>
                    </select>
                    <!-- <hr> -->
<!--                     
                    
                    <br> -->

                </div>
            </div>
            <!-- <div id="tabs-5" aria-labelledby="ui-id-7" class="ui-tabs-panel ui-widget-content ui-corner-bottom" role="tabpanel" aria-hidden="true" style="display: none;"> -->
            <div id="tabs-5" aria-labelledby="ui-id-7" class="ui-tabs-panel ui-widget-content ui-corner-bottom" role="tabpanel" aria-hidden="true" style="overflow: hidden;">

                <div class="use-case-5" id="transversal_services_div" style="display: none">
                    <!-- <span name="lbl" caption="Services_Categories_T">Services Categories</span>
                    <br> -->
                    <input type="checkbox" name="macro-select-all_t" id="macro-select-all_t" value="Select All"> <span
                        name="lbl" caption="Select_All_T">De/Select All</span>
                    <div id="categorie_t"></div>
                    <!-- <br> -->
                    <hr>
                    <!-- <span name="lbl" caption="Filter_Results_dx_T">Filter</span>:
                    <br> -->


                    <div>
                        <div class="menu" id="serviceSearch">
                            <img src="img/search_icon.png" alt="Search Services" width="24"
                                onclick="ricercaServizi('categorie_t', null, null);">
                        </div>
                        <!--<div class="menu" id="textSearch">
                                    <img src="img/text_search.jpg" alt="Text Search" width="28" onclick="showTextSearchDialog();" />
                                </div>-->
                        <div class="menu" id="clearAll">
                            <img src="img/clear_icon.png" alt="Clear all" width="28" onclick="resetTotale();">
                        </div>
                        <!--<input type="checkbox" name="open_path" value="open_path" id="apri_path" />  <span>Open Path/Area</span>-->
                        <!-- DA DECOMMENTARE QUANDO SARA' FATTO IL SALVATAGGIO DEI SERVIZI TRASVERSALI -->
                        <div class="menu" id="saveQuery">
                            <!-- <img id="save_disc_t" src="img/save_disable.png" alt="" width="28"   disabled> -->
                            <input id="save_disc_t" class="save_disk" type="image" src="img/save_disable.png" alt="Salva la query" width="28" style="cursor: default;" onclick="save_handler(null, null, null, null, 'query_t');">
                        </div>
                        <br><br><hr>
                    </div >    

                    <div>
                        <fieldset>
                            <legend><span name="lbl" caption="Additional Filters">Additional Filters</span></legend>
                    <input type="text" name="serviceTextFilter_t" id="serviceTextFilter_t"
                        placeholder="search text into service"
                        onkeypress="event.keyCode == 13 ? ricercaServizi('categorie_t', null, null) : false"><br>
                    <span name="lbl" caption="Num_Results_dx_T">N. results</span>:
                    <select id="nResultsServizi_t" name="nResultsServizi" style="margin-bottom: 5px;left: 21px;position: relative;">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100" selected="selected">100</option>
                        <option value="200">200</option>
                        <option value="500">500</option>
                        <option value="0">No Limit</option>
                    </select>
                    <br>
                   
                    <span name="lbl" caption="Search_Range_T">Search Range</span>
                    <select id="raggioricerca_t" name="raggioricerca" style="margin-left: 57px;">
                        <option value="0.1">100 mt</option>
                        <option value="0.2">200 mt</option>
                        <option value="0.3">300 mt</option>
                        <option value="0.5">500 mt</option>
                        <option value="1">1 km</option>
                        <option value="2">2 km</option>
                        <option value="5">5 km</option>
                        <option value="10">10 km</option>
                        <option value="area" selected="selected">visible areas</option>
                    </select>
                    <!-- <hr>

                    <br> -->
                    </fieldset>
                </div>
            </div>
            </div>
            <div id="tree">
            </div>
        </div>
        <fieldset id="searchOutput" style="position: relative;top: -10px;">
            <legend><span name="lbl" caption="Search_Results">Search Results</span></legend>
            <div class="result" id="cluster-msg"></div>
            <div class="result" id="msg"></div>
            <div class="result" id="serviceRes"><img src="img/mapicons/TourismService.png" height="21" width="21"
                    align="top"><span class="label">Services:</span>
                <div class="value"></div>
            </div>
            <div class="result" id="busstopRes"><img src="img/mapicons/TransferServiceAndRenting_BusStop.png"
                    height="21" width="21" align="top"><span class="label">Bus Stops:</span>
                <div class="value"></div>
            </div>
            <div class="result" id="busDirection"><span class="label">Direction:</span>
                <div class="value"></div>
            </div>
            <div class="result" id="sensorRes"><img src="img/mapicons/TransferServiceAndRenting_SensorSite.png"
                    height="21" width="21" align="top"><span class="label">Road Sensors:</span>
                <div class="value"></div>
            </div>
        </fieldset>
        <fieldset id="resultTPL">
            <legend><span name="lbl" caption="Results_BusLines">Bus Lines</span></legend>
            <div id="numTPL" style="display:none;"></div>
            <div id="listTPL"></div>
        </fieldset>
    </div>
    </div>

    <div id="info-aggiuntive" class="menu">
        <div class="header"><span name="lbl" caption="Hide_Menu_meteo"> - Hide Menu</span>
        </div>
        <div class="content" id="content"></div>
    </div>

    <script>

var msm_access_token="";
var msm_authenticated=false;
var msm_username="";
var msm_org="";

var MultiServiceMap = {

initialize: function () {

    MultiServiceMap.keycloak = Keycloak({
        "realm": realm,
        "url": authUrl,
        "clientId":clientId
    });

    // MultiServiceMap.keycloak.onTokenExpired = ()=>{
    //         console.log('expired '+new Date());
    //         MultiServiceMap.keycloak.updateToken(50).success((refreshed)=>{
    //             if (refreshed){

    //             // Promise constructor
    //             let promise = new Promise(function(resolve, reject) {

    //             if (typeof MultiServiceMap.keycloak.token!= "undefined") {
    //                     resolve();
    //                 } else {
    //                     reject();
    //                 }
    //             });
    //             // Consuming the Promise
    //             promise
    //             .then(function () {
    //                 msm_access_token=MultiServiceMap.keycloak.token;
    //                 console.log('refreshed '+new Date());
    //             })
    //             .catch(function () {
    //                 console.log('Some error has occured');
    //             });
    //             }else {
    //                 console.log('not refreshed '+new Date());
    //             }
    //         }).error(() => {
    //              console.error('Failed to refresh token '+new Date());
    //         });
    //         }

    MultiServiceMap.keycloak.init({
        onLoad: 'check-sso'
    }).success(
        function (authenticated) {
            //console.log(authenticated);
            if (authenticated) {
                console.log("AUTHENTICATED");
                msm_access_token=MultiServiceMap.keycloak.token;
                msm_username=MultiServiceMap.keycloak.tokenParsed.preferred_username;
                msm_org=getOrganization();
                document.getElementById("span_username").textContent="Username: "+msm_username;
                document.getElementById("span_org").textContent=", Org: "+msm_org;
                document.getElementById("org_selector").value=msm_org;
                document.getElementById("login").style.display='none';
                document.getElementById("userPass").style.paddingTop='10px';
                document.getElementById("userPass").style.fontWeight='bold';
                document.getElementById("login_div").style.height='20px';

                for (let i = 0; i < orgs.length; i++) {
                    if(orgs[i]==msm_org){
                        selectedorgUrl=orgApiUrls[i];
                         document.getElementById("org_selector").selectedIndex = i;
                        // document.getElementById("org_selector").value=msm_org;
                        // $("select#elem")[0].selectedIndex = 0;
                        mostraElencoAgenzie_api(orgApiUrls[i]);
                        center = orgCenterLatLng[i];
                        center_lat = center.substring(0, center.indexOf(","));
                        center_lon = center.substring(center.indexOf(",") + 1, center.length);
                        map.setView([center_lat, center_lon], getOrgZoomLevel(selectedorgUrl));
                    }
                }

            } else {
                console.log("Not Authenticated..");
            }
        }).error(function (err) {
            console.log(err);
    });
}
}

function check_token(){
                // if (typeof MultiServiceMap.keycloak.token!= "undefined") {
                    if (msm_access_token!= "") {
                    console.log('Token available..');
                    msm_access_token=MultiServiceMap.keycloak.token;
                }else{
                    console.log('Token is not available..');
                    // MultiServiceMap.keycloak.login();
                    MultiServiceMap.keycloak.login();
                }
}

function getOrganization() {
  // strUrl is whatever URL you need to call
  org = "";

  jQuery.ajax({
    url: ldapApiUrl+msm_username,
    success: function(response) {
      org = response.content;
    },
    async:false
  });
  return org;
}

$(document).ready(function() {

    document.getElementById('content').style.display ='block';
    
    //fill organization combobox
    // Instantiate an new XHR Object
    const xhr_org_selector = new XMLHttpRequest();

// Open an obejct (GET/POST, PATH, ASYN-TRUE/FALSE)
xhr_org_selector.open("GET", orgApiUrl, false);

// When response is ready
xhr_org_selector.onload = function () {
    if (this.status === 200) {

        //Add All Organizations
        var opt = document.createElement("option");

        // Assign text and value to Option object
        opt.text = "All Organizations";
        opt.value = superServiceMapApiUrl;

        orgs.push("All Organizations");
        orgApiUrls.push(superServiceMapApiUrl);
        orgCenterLatLng.push('48.3708, 10.4589');
        orgZoomLevel.push(5);

        // Add an Option object to Drop Down List Box
        document.getElementById('org_selector').options.add(opt);
        document.getElementById("org_selector").selectedIndex = 0;

        // Changing string data into JSON Object
        obj = JSON.parse(this.responseText);

        for (var i = 0; i <= obj.length - 1; i++) {
            organizationName = `${obj[i].organizationName}`;

            kbUrl = `${obj[i].kbUrl}`;
            center = `${obj[i].gpsCentreLatLng}`;

            // Create an Option object       
            var opt = document.createElement("option");

            // Assign text and value to Option object
            opt.text = organizationName;
            opt.value = kbUrl + "|" + center;

            orgs.push(organizationName);
            orgApiUrls.push(kbUrl);
            orgCenterLatLng.push(center);
            orgZoomLevel.push(`${obj[i].zoomLevel}`);

            // Add an Option object to Drop Down List Box
            document.getElementById('org_selector').options.add(opt);
        }
    } else {
        console.log("File not found");
    }
}

    // At last send the request 
    xhr_org_selector.send();


    function loadPlatformJSON(callback) {
            var xobj = new XMLHttpRequest();
            xobj.overrideMimeType("application/json");
            xobj.open('GET', 'conf/platforms.json', false); // Replace 'my_data' with the path to your file
            xobj.onreadystatechange = function () {
                if (xobj.readyState == 4 && xobj.status == "200") {
                    // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
                    callback(xobj);
                }
            };
            xobj.send(null);
        }
        
        loadPlatformJSON(function (response) {
                    // preserve newlines, etc - use valid JSON
                    platform = response.response.replace(/\\n/g, "\\n")
                        .replace(/\\'/g, "\\'")
                        .replace(/\\"/g, '\\"')
                        .replace(/\\&/g, "\\&")
                        .replace(/\\r/g, "\\r")
                        .replace(/\\t/g, "\\t")
                        .replace(/\\b/g, "\\b")
                        .replace(/\\f/g, "\\f");
                    // remove non-printable and other non-valid JSON chars
                    platform = platform.replace(/[\u0000-\u0019]+/g, "");

                    // Changing string data into JSON Object
                    obj_platform =  eval('(' + platform + ')');

                for (var i = 0; i <= obj_platform.length - 1; i++) {
                    organizationName = `${obj_platform[i].organizationName}`;

                    kbUrl = `${obj_platform[i].kbUrl}`;
                    center = `${obj_platform[i].gpsCentreLatLng}`;

                    // Create an Option object       
                    var opt = document.createElement("option");

                    // Assign text and value to Option object
                    opt.text = organizationName;
                    opt.value = kbUrl + "|" + center;

                    orgs.push(organizationName);
                    orgApiUrls.push(kbUrl);
                    platform_orgApiUrls.push(kbUrl);
                    orgCenterLatLng.push(center);
                    orgZoomLevel.push(`${obj_platform[i].zoomLevel}`);
                    platform_orgZoomLevel.push(`${obj_platform[i].zoomLevel}`);

                    // Add an Option object to Drop Down List Box
                    document.getElementById('org_selector').options.add(opt);
                }
        });

        mostraElencoAgenzie_api(selectedorgUrl);
        init();
});

    // Disable save icons
    var save_disk_inputs = document.querySelectorAll('input.save_disk');

    for (var i = 0; i < save_disk_inputs.length; i++) {
        save_disk_inputs[i].disabled = true;
    }

    $( "#path_date" ).datepicker( "setDate", new Date());
    MultiServiceMap.initialize();

////////////////////////////////////////////////////////////////////MANAGE TRANSVERSAL CATEGORIES////////////////////////////////////////////////////////
        search = document.querySelector("#search-categories");
        let nature_transversal_list = [];
        let sub_nature_transversal_list = [];
        let filtered_transversal_nature_list = [];
        let filtered_transversal_sub_nature_list = [];
        let search_transversal_categories = false;

        let categorie_t_innerHTML = "";
        let categorie_innerHTML = "";

        let nature_list = [];
        let sub_nature_list = [];
        let search_categories = false;
        let filtered_nature_list = [];
        let filtered_sub_nature_list = [];

        let transversal_services_obj;
        let services_obj;

        var typingTimer;                //timer identifier
        var doneTypingInterval = 400;  //time in ms, 5 second for example

        function loadTransversalServicesJSON(callback) {
            var xobj = new XMLHttpRequest();
            xobj.overrideMimeType("application/json");
            xobj.open('GET', 'conf/transversal_services.json', false); // Replace 'my_data' with the path to your file
            xobj.onreadystatechange = function () {
                if (xobj.readyState == 4 && xobj.status == "200") {
                    // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
                    callback(xobj);
                }
            };
            xobj.send(null);
        }

        manageTransversalCategories(filtered_transversal_nature_list, filtered_transversal_sub_nature_list);

        function manageTransversalCategories(filtered_nature_list, filtered_sub_nature_list) {

            var categorieDiv = document.getElementById("categorie_t");
            categorieDiv.innerHTML = "";

            if (transversal_services_obj == undefined) {
                // load json
                loadTransversalServicesJSON(function (response) {

                    // preserve newlines, etc - use valid JSON
                    s = response.response.replace(/\\n/g, "\\n")
                        .replace(/\\'/g, "\\'")
                        .replace(/\\"/g, '\\"')
                        .replace(/\\&/g, "\\&")
                        .replace(/\\r/g, "\\r")
                        .replace(/\\t/g, "\\t")
                        .replace(/\\b/g, "\\b")
                        .replace(/\\f/g, "\\f");
                    // remove non-printable and other non-valid JSON chars
                    s = s.replace(/[\u0000-\u0019]+/g, "");

                    // Changing string data into JSON Object
                    transversal_services_obj = JSON.parse(s);

                    for (let i = 0; i < transversal_services_obj.content.length; i++) {
                        nature = `${transversal_services_obj.content[i].nature}`;
                        nature_transversal_list[i] = nature;
                        var children = transversal_services_obj.content[i].children;
                        if (children.length != 0) {
                            for (let child_index = 0; child_index < children.length; child_index++) {
                                var child = children[child_index];
                                sub_nature_transversal_list.push(child.sub_nature);
                            }
                        }
                    }
                });
            }

            if (search_transversal_categories == false) {

                for (let i = 0; i < transversal_services_obj.content.length; i++) {
                    nature = `${transversal_services_obj.content[i].nature}`;
                    nature_img = `${transversal_services_obj.content[i].nature_img}`;
                    fillCategorie('transversal', nature, nature_img, categorieDiv);
                }
            } else {
                ///transversal_services////////transversal_services////////////////transversal_services///////transversal_services//////transversal_services/////////////////////
                ///search categories////////search categories////////////////search categories///////search categories//////search categories////////////////////////////////////
                var nature = "";

                for (let i = 0; i < transversal_services_obj.content.length; i++) {
                    nature = `${transversal_services_obj.content[i].nature}`;
                    nature_img = `${transversal_services_obj.content[i].nature_img}`;
                    if (filtered_transversal_nature_list.includes(nature)) {
                        fillCategorie('transversal', nature, nature_img, categorieDiv);
                    } else {
                        var children = transversal_services_obj.content[i].children;
                        if (children.length != 0) {
                            for (let child_index = 0; child_index < children.length; child_index++) {
                                sub_nature = `${children[child_index].sub_nature}`;
                                if (filtered_transversal_sub_nature_list.includes(sub_nature)) {
                                    fillCategorie('transversal', nature, nature_img, categorieDiv);
                                }
                            }
                        }
                    }
                }
            }
        }
        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        function fillCategorie(service_type, nature, nature_img, categorieDiv) {

            var categorieDiv_inner_html = '<input type=\"checkbox\" name=\"' + nature + '\" value="' + nature + '" class=\"macrocategory\"  height=\"20px\"  style=\"-webkit-transform: scale(0.9);\">';

            if (service_type == 'transversal') {
                categorieDiv_inner_html += '<img src=\"img/mapicons/' + nature_img + '.png\" height=\"20\" width=\"20" align=\"top\" checked=\checked\">';
            } else {
                categorieDiv_inner_html += '<img src=\"img/mapicons/' + nature + '.png\" height=\"20\" width=\"20\" align=\"top\" checked=\"checked\">';
            }

            categorieDiv_inner_html += '<span class=\"' + nature + ' macrocategory-label\" checked=\"checked\">' + nature + '</span>';

            if (service_type == 'transversal') {
                categorieDiv_inner_html += '<span id=\"' + nature + '|nature_span\" class=\"toggle-subcategory\" title=\"Mostra sottocategorie\" checked=\"checked\">+</span>';
                categorieDiv_inner_html += '<div id=\"' + nature + '|subcategory_div\" class=\"subcategory-content\" title=\"Mostra sottocategorie\" checked=\"checked\"></div>';
            } else {
                categorieDiv_inner_html += '<span id=\"' + nature + '_nature_span\" class=\"toggle-subcategory\" title=\"Mostra sottocategorie\" checked=\"checked\">+</span>';
                categorieDiv_inner_html += '<div id=\"' + nature + '_subcategory_div\" class=\"subcategory-content\"  checked=\"checked\"></div>';
            }

            categorieDiv_inner_html += '<br>';

            categorieDiv.innerHTML += categorieDiv_inner_html;

            if (service_type == 'transversal') {
                manage_transvesal_sub_nature(nature + '|nature_span', transversal_services_obj);
            } else {
                manage_sub_nature(nature + '_nature_span', services_obj);
            }

            // SELEZIONA/DESELEZIONA TUTTE LE CATEGORIE - SOTTOCATEGORIE
            $('.macrocategory').change(function () {
                $cat = $(this).next().next().attr('class');
                $cat = $cat.replace(" macrocategory-label", "");

                if ($(this).prop('checked')) {
                    $('.sub_' + $cat).prop('checked', 'checked');
                } else {
                    $('.sub_' + $cat).prop('checked', false);
                }
            });
            // SELEZIONE/DESELEZIONE MACROCATEGORIA DA SOTTOCATEGORIA
            $('.subcategory').change(function () {
                $subcat = $(this).next().next().attr('class');
                $cat = $subcat.replace(" subcategory-label", "");
                if ($(this).prop('checked')) {
                    $('.' + $cat + '.macrocategory-label').prev().prev().prop('checked', 'checked');
                } else {
                    if (($('input.sub_' + $cat + '.subcategory:checked').length) == 0) {
                        $('.' + $cat + '.macrocategory-label').prev().prev().prop('checked', false);
                    }
                }
            });
        }

        function manage_transvesal_sub_nature(nature_span_id, transversal_services_obj) {
            var found = false;
            var nature = nature_span_id.substring(0, nature_span_id.indexOf('|'));

            var subcategory_div_id = nature + '|subcategory_div';
            var subcategory_div = document.getElementById(subcategory_div_id);

            var nature_plus_span = document.getElementById(nature_span_id);
            var nature_plus_span_text = nature_plus_span.textContent;
            document.getElementById(subcategory_div_id).innerHTML = '';

            for (let i = 0; i < transversal_services_obj.content.length; i++) {
                if (transversal_services_obj.content[i].nature == nature) {
                    var children = transversal_services_obj.content[i].children;
                    if (children.length != 0) {
                        for (let child_index = 0; child_index < children.length; child_index++) {
                            var sub_nature = `${children[child_index].sub_nature}`;
                            var sub_nature_img = `${children[child_index].sub_nature_img}`;
                            if (search_transversal_categories == false) {
                                getSubNature(subcategory_div, nature, sub_nature, sub_nature_img,'transversal');
                            } else {
                                if (filtered_transversal_sub_nature_list.includes(sub_nature)) {
                                    found = true;
                                    getSubNature(subcategory_div, nature, sub_nature, sub_nature_img,'transversal');
                                }
                            }
                        }
                    } else {
                        var nature_span = document.getElementById(nature + "|nature_span");
                        nature_span.remove();
                    }
                    if (found == false && search_transversal_categories == true && children.length != 0) {
                        for (let child_index = 0; child_index < children.length; child_index++) {
                            sub_nature = `${children[child_index].sub_nature}`;
                            sub_nature_img = `${children[child_index].sub_nature_img}`;
                            getSubNature(subcategory_div, nature, sub_nature, sub_nature_img,'transversal');
                        }
                    }
                }
            }
        }
        ////////////////////////////////////////////////////////////////////END MANAGE TRANSVERSAL CATEGORIES////////////////////////////////////////////////////////
        ////////////////////////////////////////////////////////////////////END MANAGE TRANSVERSAL CATEGORIES////////////////////////////////////////////////////////
            // bind change event to select
            $('#org_selector').on('change', function () {

                // Disable save icons
                var save_disk_inputs = document.querySelectorAll('input.save_disk');
                //empty weather info box
                svuotaInfoAggiuntive();

                for (var i = 0; i < save_disk_inputs.length; i++) {
                    save_disk_inputs[i].disabled = true;
                    save_disk_inputs[i].setAttribute("src","img/save_disable.png");
                    save_disk_inputs[i].style.cursor="default";
                }

                var value = $(this).val(); // get selected value
                if (value) { // require a URL
                    if (value == superServiceMapApiUrl) {
                        selectedorgUrl=superServiceMapApiUrl;
                        mostraElencoAgenzie_api(selectedorgUrl);
                        map.setView(['48.3708', '10.4589'], 5);
                    } else {
                        seperator = value.indexOf("|");
                        selectedorgUrl = value.substring(0, seperator);
                        mostraElencoAgenzie_api(selectedorgUrl);

                        center = value.substring(seperator + 1, value.length);
                        center_lat = center.substring(0, center.indexOf(","));
                        center_lon = center.substring(center.indexOf(",") + 1, center.length);
                        map.setView([center_lat, center_lon], getOrgZoomLevel(selectedorgUrl));
                    }
                }
                return false;
            });

        function getOrgZoomLevel(kbUrl) {

            var zoomLevel = "";

            if(platform_orgApiUrls.includes(kbUrl)){
                var index=platform_orgApiUrls.indexOf(kbUrl);
                zoomLevel=platform_orgZoomLevel[index];
            }else{

            const xhr = new XMLHttpRequest();
            // Open an obejct (GET/POST, PATH, ASYN-TRUE/FALSE)
            xhr.open("GET", orgApiUrl, false);
            // When response is ready
            xhr.onload = function () {
                if (this.status === 200) {

                    // Changing string data into JSON Object
                    obj = JSON.parse(this.responseText);
                    

                    for (let i = 0; i < obj.length; i++) {
                        var orgKbUrl = `${obj[i].kbUrl}`;
                        if (kbUrl == orgKbUrl) {
                            zoomLevel = `${obj[i].zoomLevel}`;
                        }
                    }

                    if(zoomLevel==""){
                        zoomLevel=5;
                    }
                } else {
                    console.log("File not found");
                }
            }
            // At last send the request 
            xhr.send();
        }
            return zoomLevel;
        }
        ////////////////////////////////////////////////////////////////SEARCH CATEGORIES/////////////////////////////////////////////////////////////////
        ////////////////////////////////////////////////////////////////SEARCH CATEGORIES/////////////////////////////////////////////////////////////////
        const cleanupWord = word => {
            return word.trim().toLowerCase();
        }

        const filterTransversalNatureList = word => {
            return nature_transversal_list.filter(item => item.toLowerCase().includes(word));
        }

        const filterTransversalSubNatureList = word => {
            return sub_nature_transversal_list.filter(item => item.toLowerCase().includes(word));
        }

        const filterNatureList = word => {
            return nature_list.filter(item => item.toLowerCase().includes(word));
        }

        const filterSubNatureList = word => {
            return sub_nature_list.filter(item => item.toLowerCase().includes(word));
        }

        const renderCategories = (word = "") => {

            search_categories = true;
            search_transversal_categories = true;

            word = cleanupWord(word);

            filtered_nature_list = [];
            filtered_sub_nature_list = [];

            filtered_transversal_nature_list = [];
            filtered_transversal_sub_nature_list = [];

            filtered_nature_list = filterNatureList(word);
            filtered_sub_nature_list = filterSubNatureList(word);

            //remove duplicates
            filtered_nature_list = filtered_nature_list.filter(function (value, index, filtered_nature_list) {
                return filtered_nature_list.indexOf(value) === index;
            });

            //remove duplicates
            filtered_sub_nature_list = filtered_sub_nature_list.filter(function (value, index, filtered_sub_nature_list) {
                return filtered_sub_nature_list.indexOf(value) === index;
            });

            filtered_transversal_nature_list = filterTransversalNatureList(word);
            filtered_transversal_sub_nature_list = filterTransversalSubNatureList(word);

            //remove duplicates
            filtered_transversal_nature_list = filtered_transversal_nature_list.filter(function (value, index, filtered_transversal_nature_list) {
                return filtered_transversal_nature_list.indexOf(value) === index;
            });

            //remove duplicates
            filtered_transversal_sub_nature_list = filtered_transversal_sub_nature_list.filter(function (value, index, filtered_transversal_sub_nature_list) {
                return filtered_transversal_sub_nature_list.indexOf(value) === index;
            });

            if (filtered_sub_nature_list.length != 0) {
                //update filtered_nature_list by adding the natures of sub_natures in filtered_sub_nature_list
                for (let i = 0; i < filtered_sub_nature_list.length; i++) {
                    var filtered_sub_nature = filtered_sub_nature_list[i];
                    filtered_nature = getNature(filtered_sub_nature);
                    if (filtered_nature_list.includes(filtered_nature) == false && filtered_nature != "") {
                        filtered_nature_list.push(filtered_nature);
                    }
                }
            }

            if (filtered_transversal_sub_nature_list.length != 0) {
                //update filtered_transversal__nature_list by adding the natures of sub_natures in filtered_transversal_sub_nature_list
                for (let i = 0; i < filtered_transversal_sub_nature_list.length; i++) {
                    var filtered_transversal_sub_nature = filtered_transversal_sub_nature_list[i];
                    filtered_transversal_nature = getTransversalNature(filtered_transversal_sub_nature);
                    if (filtered_transversal_nature_list.includes(filtered_transversal_nature) == false && filtered_transversal_nature != "") {
                        filtered_transversal_nature_list.push(filtered_transversal_nature);
                    }
                }
            }
            manageCategories(filtered_nature_list, filtered_sub_nature_list);
            manageTransversalCategories(filtered_transversal_nature_list, filtered_transversal_sub_nature_list);
            $(".toggle-subcategory").click(function () {
    
    $tsc = $(this);
    //getting the next element
    $content = $tsc.next();
    if (!$content.is(":visible")) {
        $('.subcategory-content').hide();
        $('.toggle-subcategory').html('+');
    }
//open up the content needed - toggle the slide- if visible, slide up, if not slidedown.
    $content.slideToggle(200, function () {
//execute this after slideToggle is done
//change text of header based on visibility of content div
        $tsc.text(function () {
//change text based on condition
            return $content.is(":visible") ? "-" : "+";
        });
    });
});
        }

        //on keyup, start the countdown
        $('#search-categories').keyup(function () {
            clearTimeout(typingTimer);
            // if ($('#in').val) {
            typingTimer = setTimeout(function () {
                if (search.value == "") {
                    search_categories = false;
                    search_transversal_categories = false;
                    filtered_transversal_nature_list = [];
                    filtered_transversal_sub_nature_list = [];
                    filtered_nature_list = [];
                    filtered_sub_nature_list = [];

                    manageCategories(filtered_nature_list, filtered_sub_nature_list);
                    manageTransversalCategories(filtered_transversal_nature_list, filtered_transversal_sub_nature_list);

                    $(".toggle-subcategory").click(function () {
                    $tsc = $(this);
                    //getting the next element
                    $content = $tsc.next();
                    if (!$content.is(":visible")) {
                        $('.subcategory-content').hide();
                        $('.toggle-subcategory').html('+');
                    }
                //open up the content needed - toggle the slide- if visible, slide up, if not slidedown.
                    $content.slideToggle(200, function () {
                //execute this after slideToggle is done
                //change text of header based on visibility of content div
                        $tsc.text(function () {
                //change text based on condition
                            return $content.is(":visible") ? "-" : "+";
                        });
                    });
                });

                } else {
                    renderCategories(search.value);
                }
            }, 500);
            // }
        });

        function getNature(filtered_sub_nature) {

            var nature = "";
            for (let i = 0; i < services_obj.content.length; i++) {
                var children = `${services_obj.content[i].children_value}`.split(",");

                for (let child_index = 0; child_index < children.length; child_index++) {
                    var sub_nature = children[child_index];
                    if (sub_nature == filtered_sub_nature) {
                        nature = `${services_obj.content[i].value}`;
                        break;
                    }
                }
            }
            return nature;
        }

        function getTransversalNature(filtered_transversal_sub_nature) {
            // Changing string data into JSON Object
            var subnature = "";
            var nature = "";
            for (let i = 0; i < transversal_services_obj.content.length; i++) {
                var children = transversal_services_obj.content[i].children;
                for (let child_index = 0; child_index < children.length; child_index++) {
                    var subnature = children[child_index].sub_nature;
                    if (subnature == filtered_transversal_sub_nature) {
                        nature = `${transversal_services_obj.content[i].nature}`;
                        break;
                    }
                }
            }
            return nature;
        }
        ////////////////////////////////////////////////////////////////END SEARCH CATEGORIES/////////////////////////////////////////////////////////////////
        ////////////////////////////////////////////////////////////////END SEARCH CATEGORIES/////////////////////////////////////////////////////////////////
        manageCategories(filtered_nature_list, filtered_sub_nature_list);
        var map = document.getElementById("map");

        function manageCategories(filtered_nature_list, filtered_sub_nature_list) {
            var categorieDiv = document.getElementById("categorie");
            categorieDiv.innerHTML = "";
            var nature = "";

            if (search_categories == false) {
                if (services_obj == undefined) {
                    // Instantiate an new XHR Object
                    const xhr = new XMLHttpRequest();
                    // Open an obejct (GET/POST, PATH, ASYN-TRUE/FALSE)
                    xhr.open("GET", natureApiUrl, false);
                    // When response is ready
                    xhr.onload = function () {
                        if (this.status === 200) {
                            // Changing string data into JSON Object
                            services_obj = JSON.parse(this.responseText);

                            for (let services_obj_index = 0; services_obj_index < services_obj.content.length; services_obj_index++) {
                                nature = `${services_obj.content[services_obj_index].value}`;
                                if (nature != 'undefined') {
                                    nature_list[services_obj_index] = nature;
                                    fillCategorie('regular', nature, '', categorieDiv);
                                }
                            }
                        } else {
                            console.log("File not found");
                        }
                    }
                    // At last send the request 
                    xhr.send();
                } else {
                    for (let services_obj_index = 0; services_obj_index < services_obj.content.length; services_obj_index++) {
                        nature = `${services_obj.content[services_obj_index].value}`;
                        if (nature != 'undefined') {
                            nature_list[services_obj_index] = nature;
                            fillCategorie('regular', nature, '', categorieDiv);
                        }
                    }
                }
            } else {
                ///search categories////////search categories////////////////search categories///////search categories//////search categories//////////////////////////////////
                for (let services_obj_index = 0; services_obj_index < services_obj.content.length; services_obj_index++) {
                    nature = `${services_obj.content[services_obj_index].value}`;
                    if (filtered_nature_list.includes(nature)) {
                        nature_list[services_obj_index] = nature;
                        if (nature != 'undefined') {
                            fillCategorie('regular', nature, '', categorieDiv);
                        }
                    }
                }
            }
        }

        function manage_sub_nature(nature_span_id, services_obj) {
            var found = false;
            var nature = nature_span_id.substring(0, nature_span_id.indexOf('_'));
            subcategory_div_id = nature + '_subcategory_div';
            subcategory_div = document.getElementById(subcategory_div_id);

            nature_plus_span = document.getElementById(nature_span_id);
            nature_plus_span_text = nature_plus_span.textContent;

            document.getElementById(subcategory_div_id).innerHTML = '';
            sub_nature = "";

            if (search_categories == false) {
                for (let i = 0; i < services_obj.content.length; i++) {
                    if (services_obj.content[i].value == nature) {
                        sub_natures = `${services_obj.content[i].children_value}`.split(",");
                        for (let sub_nature_index = 0; sub_nature_index < sub_natures.length; sub_nature_index++) {
                            sub_nature_list.push(sub_natures[sub_nature_index]);
                            getSubNature(subcategory_div, nature, sub_natures[sub_nature_index],'regular');
                        }
                    }
                }
            } else {
                for (let i = 0; i < services_obj.content.length; i++) {
                    if (services_obj.content[i].value == nature) {
                        sub_natures = `${services_obj.content[i].children_value}`.split(",");
                        for (let sub_nature_key = 0; sub_nature_key < sub_natures.length; sub_nature_key++) {
                            if (filtered_sub_nature_list.includes(sub_natures[sub_nature_key])) {
                                found = true;
                                getSubNature(subcategory_div, nature, sub_natures[sub_nature_key],'regular');
                            }
                        }
                    }
                }
                if (found == false) {
                    for (let i = 0; i < sub_natures.length; i++) {
                        getSubNature(subcategory_div, nature, sub_natures[i],'regular');
                    }
                }
            }
        }

        // function getSubNature(subcategory_div, nature, sub_nature) {

        //     var checkbox_sub_nature = document.createElement("input");   // Create a subnature checkbox node       
        //     // Assigning the attributes to created checkbox
        //     checkbox_sub_nature.type = "checkbox";
        //     checkbox_sub_nature.name = sub_nature;
        //     checkbox_sub_nature.value = sub_nature;
        //     checkbox_sub_nature.className = "sub_" + nature + " subcategory";
        //     subcategory_div.appendChild(checkbox_sub_nature);

        //     var img_sub_nature = document.createElement("img");                 // Create a img node 
        //     // Assigning the attributes to created img
        //     img_sub_nature.src = "img/mapicons/" + nature + "_" + sub_nature + ".png";
        //     img_sub_nature.height = "19";
        //     img_sub_nature.width = "16";
        //     img_sub_nature.align = "top";
        //     subcategory_div.appendChild(img_sub_nature);

        //     var span_sub_nature = document.createElement("span");                 // Create a plus span node 
        //     // Assigning the attributes to created span
        //     span_sub_nature.className = nature + " subcategory-label";
        //     span_sub_nature.textContent = sub_nature;
        //     subcategory_div.appendChild(span_sub_nature);

        //     var br = document.createElement('br');
        //     subcategory_div.appendChild(br);
        // }

        function getSubNature(subcategory_div, nature, sub_nature, sub_nature_img,service_type) {
           
            var subcategory_div_inner_html='<input type=\"checkbox\" name=\"'+sub_nature+'\" value=\"'+sub_nature+'\" class=\"sub_'+nature+' subcategory\">';
           
            if(service_type=='transversal'){
                subcategory_div_inner_html+='<img src=\"img/mapicons/'+sub_nature_img+'.png\" height=\"19\" width=\"16\" align=\"top\" checked=\"checked\">';
            }else{

                if(sub_nature=='Smart_street_light'){
                    subcategory_div_inner_html+='<img src=\"img/mapicons/'+nature+'_Street_light.png\" height=\"19\" width=\"16\" align=\"top\" checked=\"checked\">'; 
                }else{
                    subcategory_div_inner_html+='<img src=\"img/mapicons/'+nature+'_'+sub_nature+'.png\" height=\"19\" width=\"16\" align=\"top\" checked=\"checked\">';
                }
            }
                      
            subcategory_div_inner_html+='<span class=\"'+nature+' subcategory-label\" checked=\"checked\">'+sub_nature+'</span>';
            subcategory_div_inner_html+='<br>';

            subcategory_div.innerHTML+=subcategory_div_inner_html;
        }
        //////////////////////////////////////////////////////////////////////////////////////////
        //////////////////////////////////////////////////////////////////////////////////////////
        // $("#embed").hide();
        //    var ctx = "/WebAppGrafo";
        var ctx = "";
        //var ctx = "http://servicemap.disit.org/WebAppGrafo";
        var query = new Object();
        //var query_event = new Object();//michela
        var parentQuery = "";
        var pins = "";
        var save_operation = "";
        var user_mail = "";
        var queryTitle = "";
        var description = "";
        var currentServiceUri = ""
        var currentIdConf = null;
        var lastEmail = "";
        Array.prototype.equals = function (array) {
            // if the other array is a falsy value, return
            if (!array)
                return false;
            // compare lengths - can save a lot of time 
            if (this.length != array.length)
                return false;
            for (var i = 0, l = this.length; i < l; i++) {
                // Check if we have nested arrays
                if (this[i] instanceof Array && array[i] instanceof Array) {
                    // recurse into the nested arrays
                    if (!this[i].equals(array[i]))
                        return false;
                }
                else if (this[i] != array[i]) {
                    // Warning - two different object instances will never be equal: {x:20} != {x:20}
                    return false;
                }
            }
            return true;
        }
        function parseUrlQuery(queryString) {
            var params = {}, queries, temp, i, l;
            // Split into key/value pairs
            queries = queryString.split("&");
            // Convert the array of strings into an object
            for (i = 0, l = queries.length; i < l; i++) {
                temp = queries[i].split('=');
                params[temp[0]] = temp[1];
            }
            return params;
        }
        function include(arr, obj) {
            return (arr.indexOf(obj) != -1);
        }
        function saveQueryFreeText(text, limit) {
            var lastQuery = new Object();
            lastQuery["text"] = text;
            lastQuery["limit"] = limit;
            lastQuery["type"] = "freeText";
            return lastQuery;
        }
        function searchText() {

            document.getElementById('saveTextSearch').removeAttribute('disabled','disabled');
            document.getElementById('saveTextSearch').src="img/save_enable.png";
            document.getElementById('saveTextSearch').style.cursor="pointer";  

            nascondiRisultati();
            var numeroEventi = 0;
            var text = $("#freeSearch").val();
            var textEv = $("#freeSearch").val();
            var limit = $("#numberResults").val();
            var numService = 0;
            var numBusstop = 0;
            var numSensor = 0;
            var numTotRes = 0;
            text = escape(text);
            $('#loading').show();
            svuotaLayers();
            query = saveQueryFreeText(text, limit);
            // numeroEventi = searchEvent("free_text", null, null, limit, textEv);
            numeroEventi = searchEvent("day", null, null, limit, textEv);
        
        if (numeroEventi != 0) {
                //risultatiRicerca((numService+numeroEventi), 0, 0, 1);
                numTotRes = numTotRes + numeroEventi;
                if (limit != 0)
                    limit = (limit - numeroEventi);
                $("input[name=event_choice][value=day]").attr('checked', 'checked');
            }

            $.ajax({
                data: {
                    search: text,
                    maxResults: limit,
                    format: 'json',
                    geometry: 'true'
                    // accessToken: msm_access_token
                },
                url: selectedorgUrl + ctx,
                //url: ctx + "/ajax/json/free-text-search_pro.jsp",
                type: "GET",
                dataType: 'json',
                async: true,
                headers: {'Authorization':'Bearer '+msm_access_token},
                success: function (data) {
                    if (data.features.length > 0) {
                        numTotRes = numTotRes + data.fullCount;
                        servicesLayer = L.geoJson(data, {
                            pointToLayer: function (feature, latlng) {
                                marker = showmarker(feature, latlng);
                                return marker;
                            },
                            onEachFeature: function (feature, layer) {
                                popupContent = "";
                                var divId = feature.id + "-" + feature.properties.tipo;
                                if (feature.properties.typeLabel == "Strada") {
                                    popupContent = popupContent + "<h3>" + feature.properties.name + " n. " + feature.properties.civic + "</h3>";
                                }
                                popupContent = popupContent + "<div id=\"" + divId + "\" ></div>";
                                layer.bindPopup(popupContent);
                                numService++;
                            }
                        });

                        if (data.features.length >= 4000) {
                            markers = new L.MarkerClusterGroup({ maxClusterRadius: 40, disableClusteringAtZoom: 17 });
                            servicesLayer = markers.addLayer(servicesLayer);
                            //$("#cluster-msg").text("piÃÂ¹ di 4000 risultati, attivato clustering");
                            $("#cluster-msg").text("more than 4000 results, clustering enable");
                            $("#cluster-msg").show();
                        }
                        else
                            $("#cluster-msg").hide();

                        servicesLayer.addTo(map);
                        var confiniMappa = servicesLayer.getBounds();
                        map.fitBounds(confiniMappa, { padding: [50, 50] });
                        $('#loading').hide();
                        risultatiRicerca(numService + numeroEventi, 0, 0, 1, null, numTotRes, 0, 0);
                    }
                    else {
                        $('#loading').hide();
                        if (numeroEventi == 0) {
                            risultatiRicerca(0, 0, 0, 0, null, 0, 0, 0);
                        } else {
                            risultatiRicerca(numeroEventi, 0, 0, 1, null, 0, 0, 0);
                        }
                    }
                },
                error: function (request, status, error) {
                    $('#loading').hide();
                    console.log(error);
                    alert('Error in searching ' + decodeURIComponent(text) + "\n The error is " + error + " " + status);
                }
            });
        }

        function showResults(parameters) {
            if (mode != "embed") {//caso in cui il link che sto visualizando ÃÂ¨ del tipo: http://.../ServiceMap/api/v1?queryId=...' o 
                var queryId = parameters["queryId"];
                if (queryId != null) {
                    $.ajax({
                        data: {
                            queryId: queryId
                            // accessToken: MultiServiceMap.keycloak.token
                        },
                        url: ctx + "/api/query.jsp",
                        type: "GET",
                        async: true,
                        dataType: 'json',
                        success: function (msg) {
                            /*     if(msg.idService != "null" && msg.idService != ""){
                             showService(msg.idService,msg.typeService);
                             }*/
                            queryTitle = msg.title;
                            description = msg.description;
                            user_mail = msg.email;
                            var htmlQueryBox = "<hr><h2>" + queryTitle + "</h2><p>" + description + "</p>";
                            $("#queryBox").append(htmlQueryBox);
                            if (!msg.isReadOnly)
                                save_operation = "write";
                            var typeSaving = msg.typeSaving;
                            if (typeSaving == "service") {
                                showService(unescape(msg.idService));
                            } else if (typeSaving == "freeText") {
                                $("#freeSearch").val(msg.text);
                                $("#numberResults").val(msg.numeroRisultatiServizi);
                                showResultsFreeSearch(msg.text, msg.numeroRisultatiServizi);
                            } else if (typeSaving == "event") {
                                //searchEvent(param, raggioRic, centroRic, numEv, text) 
                                searchEvent(msg.actualSelection, null, null, "0", null);
                            }
                            else if (typeSaving == "weather") {
                                var value = document.getElementById("org_selector").value;
                                if (value == "null") {
                                    // value = superServiceMapApiUrl;
                                    document.getElementById("org_selector").style.backgroundColor = "red";
                                    alert('Please, select an organization!');
                                } else {
                                    document.getElementById("org_selector").style.backgroundColor = "white";
                                
                                if (value == superServiceMapApiUrl) {
                                    selectedorgUrl = value;
                                    sample_coord_lat = '48.3708';
                                    sample_coord_lon = '10.4589';
                                } else {
                                    seperator = value.indexOf("|");
                                    selectedorgUrl = value.substring(0, seperator);
                                    center = value.substring(seperator + 1, value.length);
                                    sample_coord_lat = center.substring(0, center.indexOf(","));
                                    sample_coord_lon = center.substring(center.indexOf(",") + 1, center.length);
                                }

                                //fammi vedere il meteo
                                $.ajax({
                                    // url: "ajax/get-weather.jsp",
                                    url: selectedorgUrl + ctx + "location/",
                                    type: "GET",
                                    async: true,
                                    headers: {'Authorization':'Bearer '+msm_access_token},
                                    //dataType: 'json',
                                    data: {
                                        position: sample_coord_lat + ';' + sample_coord_lon
                                        // accessToken: msm_access_token
                                        // nomeComune: "FIRENZE"
                                    },
                                    success: function (msg) {
                                        parameters["info"] = 'wheather';
                                        municipalityUri = msg.municipalityUri;
                                        getWeatherInfo(selectedorgUrl + ctx, municipalityUri);
                                        //$('#loading').hide();
                                        // $('#info-aggiuntive .content').html(msg);
                                    }
                                });
                            }
                            }
                            else {//caso di embed
                                parentQuery = msg.parentQuery;
                                if (msg.nomeProvincia != "") {
                                    $("#elencoprovince").val(msg.nomeProvincia);
                                    mostraElencoComuni(msg.nomeProvincia, msg.nomeComune);
                                }
                                if (msg.line != "" && msg.line != null && msg.line != "null") {
                                    mostraElencoAgenzie();

                                    //getBusLines("query");
                                    $("#elencolinee").val(msg.line);
                                    mostraElencoFermate(msg.line, msg.stop);
                                }
                                if ((msg.actualSelection == "day") || (msg.actualSelection == "week") ||
                                    (msg.actualSelection == "mounth")) {
                                    searchEvent(msg.actualSelection, "", msg.center, "0", null);
                                }
                                var categorie = msg.categorie;
                                $("#categorie :not(:checked)").each(function () {
                                    var category = $(this).val();
                                    if (categorie.indexOf(category) > -1)
                                        $(this).attr("checked", true);
                                });
                                if (categorie.indexOf("NearBusStops") > -1)
                                    $("#Bus").attr("checked", true);
                                if (categorie.indexOf("RoadSensor") > -1)
                                    $("#Sensor").attr("checked", true);
                                var categorieArray = categorie.split(",");
                                var stringaCategorie = categorieArray.join(";");
                                stringaCategorie = stringaCategorie.replace("[", "");
                                stringaCategorie = stringaCategorie.replace("]", "");
                                stringaCategorie = stringaCategorie.replace(/\s+/g, '');
                                $("#raggioricerca").val(msg.raggioServizi);
                                $("#nResultsServizi").val(msg.numeroRisultatiServizi);
                                $("#nResultsSensori").val(msg.numeroRisultatiSensori);
                                $("#nResultsBus").val(msg.numeroRisultatiBus);
                                var text = msg.text;
                                $("#serviceTextFilter").val(text);
                                $('#selezione').html(msg.actualSelection);
                                selezione = unescape(msg.actualSelection);


                                if (typeSaving == "embed" && selezione.indexOf("COMUNE di") != -1)
                                    coordinateSelezione = null;
                                else
                                    coordinateSelezione = unescape(msg.coordinateSelezione);
                                //  if(msg.idService == "null" || msg.idService == "" || msg.idService== null)
                                if (stringaCategorie != "null")
                                    mostraServiziAJAX_new(stringaCategorie, msg.actualSelection, coordinateSelezione, msg.nomeComune, msg.numeroRisultatiServizi, msg.numeroRisultatiSensori, msg.numeroRisultatiBus, msg.raggioServizi, msg.raggioSensori, msg.raggioBus, null, text, "categorie");
                                if (msg.weatherCity != '') {
                                    // $.ajax({
                                    //     url: "ajax/get-weather.jsp",
                                    //     type: "GET",
                                    //     async: true,
                                    //     data: {
                                    //         nomeComune: msg.weatherCity
                                    //     },
                                    //     success: function (msg) {
                                    //         parameters["info"]='wheather';
                                    //         $('#info-aggiuntive .content').html(msg);
                                    //     }
                                    // });
                                    var value = document.getElementById("org_selector").value;
                                    if (value == "null") {
                                        // value = superServiceMapApiUrl;
                                        document.getElementById("org_selector").style.backgroundColor = "red";
                                        alert('Please, select an organization!');
                                    } else {
                                        document.getElementById("org_selector").style.backgroundColor = "white";
                                   
                                    if (value == superServiceMapApiUrl) {
                                        selectedorgUrl = value;
                                        sample_coord_lat = '48.3708';
                                        sample_coord_lon = '10.4589';
                                    } else {
                                        seperator = value.indexOf("|");
                                        selectedorgUrl = value.substring(0, seperator);
                                        center = value.substring(seperator + 1, value.length);
                                        sample_coord_lat = center.substring(0, center.indexOf(","));
                                        sample_coord_lon = center.substring(center.indexOf(",") + 1, center.length);
                                    }

                                    //fammi vedere il meteo
                                    $.ajax({
                                        // url: "ajax/get-weather.jsp",
                                        url: selectedorgUrl + ctx + "location/",
                                        type: "GET",
                                        async: true,
                                        headers: {'Authorization':'Bearer '+msm_access_token},
                                        //dataType: 'json',
                                        data: {
                                            position: sample_coord_lat + ';' + sample_coord_lon
                                            // accessToken: msm_access_token
                                            // nomeComune: "FIRENZE"
                                        },
                                        success: function (msg) {
                                            parameters["info"] = 'wheather';
                                            municipalityUri = msg.municipalityUri;
                                            getWeatherInfo(selectedorgUrl + ctx, municipalityUri);
                                            //$('#loading').hide();
                                            // $('#info-aggiuntive .content').html(msg);
                                        }
                                    });
                                }
                                }
                            }
                        }
                    });
                } else if (parameters["selection"] != null) {

                    // var serviceModel=unescape(parameters["model"]);
                    // if (serviceModel == "undefined")
                    // serviceModel = "";

                    var selection = unescape(parameters["selection"]);
                    if (selection == "undefined")
                        selection = "";
                    var categorie = unescape(parameters["categories"]);
                    if (categorie == "undefined")
                        categorie = "Service;BusStop;SensorSite";
                    var text = unescape(parameters["text"]);
                    if (text == "undefined")
                        text = "";
                    var risultati = unescape(parameters["maxResults"]);
                    if (risultati == "undefined" || risultati == "")
                        risultati = "100";
                    var arrayRisultati = risultati.split(";");
                    var risultatiServizi = arrayRisultati[0];
                    var risultatiSensori = (arrayRisultati.length >= 2 ? arrayRisultati[1] : risultatiServizi);
                    var risultatiBus = (arrayRisultati.length >= 3 ? arrayRisultati[2] : risultatiSensori);
                    var raggi = unescape(parameters["maxDists"]);
                    if (raggi == "undefined" || raggi == "")
                        raggi = "0.1";
                    var arrayRaggi = raggi.split(";");
                    var raggioServizi = arrayRaggi[0];
                    var raggioSensori = (arrayRaggi.length >= 2 ? arrayRaggi[1] : raggioServizi);
                    var raggioBus = (arrayRaggi.length >= 3 ? arrayRaggi[2] : raggioSensori);
                    if (selection.toLowerCase().indexOf("comune di") != -1 || selection == "") {
                        var nomeComune = selection.substring(selection.indexOf("COMUNE di") + 10);
                        mostraServiziAJAX_new(categorie, selection, coordSel, nomeComune, risultatiServizi, risultatiSensori, risultatiBus, raggioServizi, raggioSensori, raggioBus, null, text, "categorie");
                    } else {
                        if (selection.indexOf("http://") != -1) {
                            var coordSel = "";
                            $.ajax({
                                data: {
                                    serviceUri: selection
                                    // accessToken: MultiServiceMap.keycloak.token
                                },
                                url: ctx + "/ajax/getCoordinates.jsp",
                                type: "GET",
                                dataType: 'json',
                                async: true,
                                success: function (msg) {
                                    coordSel = msg.latitudine + ";" + msg.longitudine;
                                    selection = "point";
                                    mostraServiziAJAX_new(categorie, selection, coordSel, nomeComune, risultatiServizi, risultatiSensori, risultatiBus, raggioServizi, raggioSensori, raggioBus, null, text, "categorie");
                                }
                            });
                        }
                        else {
                            var coordSel = selection;
                            selection = "point";
                            mostraServiziAJAX_new(categorie, selection, coordSel, nomeComune, risultatiServizi, risultatiSensori, risultatiBus, raggioServizi, raggioSensori, raggioBus, null, text, "categorie");
                        }
                    }
                } else if (parameters["search"] != null) {
                    var textToSearch = unescape(parameters["search"]);
                    var limit = parameters["maxResults"];
                    if (limit == undefined)
                        limit = parameters["limit"];
                    if (limit == undefined)
                        limit = "100";
                    showResultsFreeSearch(textToSearch, limit);
                } else if (parameters["serviceUri"] != null) {
                    var idServices = parameters["serviceUri"].split(";");
                    //loadServiceInfo(idService)
                    for (var i = 0; i < idServices.length; i++)
                        showService(idServices[i]);
                }
                else if (api == "shortestpath") {
                    pathStart = parameters["source"];
                    pathEnd = parameters["destination"];
                    routeType = parameters["routeType"];
                    startDatetime = parameters["startDatetime"];
                    $("#path_start").html("From: " + pathStart);
                    $("#path_end").html("To: " + pathEnd);
                    if (routeType)
                        $("#path_type").val(routeType);
                    if (startDatetime) {
                        var d = startDatetime.split("T");
                        if (d.length == 2) {
                            $("#path_date").val(d[0]);
                            $("#path_time").val(d[1]);
                        }
                    }
                    $("#path").show();
                    doSearchPath(false, true); //fit
                }
                else {
                    //alert("invalid API call");
                }
            } else { //mode=="embed" // 'http://.../ServiceMap/api/embed/?idConf=....
                var idConf = parameters["idConf"]; // SO che sono in embed e uso di relativo all'embed
                if (idConf != null) {
                    $.ajax({
                        data: {
                            idConf: idConf
                            // accessToken: MultiServiceMap.keycloak.token
                        },
                        url: ctx + "/api/embed/configuration.jsp",
                        type: "GET",
                        async: true,
                        dataType: 'json',
                        success: function (msg) {
                            if (msg.weatherCity != "null" && msg.weatherCity != "") {
                                // $.ajax({
                                //     url: "ajax/get-weather.jsp",
                                //     type: "GET",
                                //     async: true,
                                //     data: {
                                //         nomeComune: msg.weatherCity
                                //     },
                                //     success: function (msg) {
                                //         $('#info-aggiuntive .content').html(msg);
                                //     }
                                // });
                                var value = document.getElementById("org_selector").value;
                                if (value == "null") {
                                    // value = superServiceMapApiUrl;
                                    document.getElementById("org_selector").style.backgroundColor = "red";
                                    alert('Please, select an organization!');
                                } else {
                                    document.getElementById("org_selector").style.backgroundColor = "white";
                               

                                if (value == superServiceMapApiUrl) {
                                    selectedorgUrl = value;
                                    sample_coord_lat = '48.3708';
                                    sample_coord_lon = '10.4589';
                                } else {
                                    seperator = value.indexOf("|");
                                    selectedorgUrl = value.substring(0, seperator);
                                    center = value.substring(seperator + 1, value.length);
                                    sample_coord_lat = center.substring(0, center.indexOf(","));
                                    sample_coord_lon = center.substring(center.indexOf(",") + 1, center.length);
                                }

                                //fammi vedere il meteo
                                $.ajax({
                                    // url: "ajax/get-weather.jsp",
                                    url: selectedorgUrl + ctx + "location/",
                                    type: "GET",
                                    async: true,
                                    headers: {'Authorization':'Bearer '+msm_access_token},
                                    //dataType: 'json',
                                    data: {
                                        position: sample_coord_lat + ';' + sample_coord_lon
                                        // accessToken: msm_access_token
                                        // nomeComune: "FIRENZE"
                                    },
                                    success: function (msg) {
                                        municipalityUri = msg.municipalityUri;
                                        getWeatherInfo(selectedorgUrl + ctx, municipalityUri);
                                        //$('#loading').hide();
                                        // $('#info-aggiuntive .content').html(msg);
                                    }
                                });
                            }
                            }
                            queryTitle = msg.title;
                            description = msg.description;
                            user_mail = msg.email;
                            var textToSearch = msg.text;
                            var c = unescape(msg.center);
                            var center = JSON.parse(c);
                            map.setView(new L.LatLng(center.lat, center.lng), msg.zoom);
                            var htmlQueryBox = "<hr><h2>" + queryTitle + "</h2><p>" + description + "</p>";
                            $("#queryBox").append(htmlQueryBox);
                            if (msg.nomeProvincia != "" && msg.nomeProvincia != "null") {
                                $("#elencoprovince").val(msg.nomeProvincia);
                                mostraElencoComuni(msg.nomeProvincia, msg.nomeComune);
                                $("#tabs").tabs("option", "active", 1);
                            }
                            if (msg.line != null && msg.line != "" && msg.line != "null") {
                                mostraElencoAgenzie();

                                //getBusLines("query");
                                $("#tabs").tabs("option", "active", 0);
                                $("#elencolinee").val(msg.line);
                                mostraElencoFermate(msg.line, msg.stop);
                            }
                            var categorie = msg.categorie;
                            $("#categorie :not(:checked)").each(function () {
                                var category = $(this).val();
                                if (categorie.indexOf(category) > -1)
                                    $(this).attr("checked", true);
                            });
                            if (categorie.indexOf("NearBusStops") > -1)
                                $("#Bus").attr("checked", true);
                            if (categorie.indexOf("RoadSensor") > -1)
                                $("#Sensor").attr("checked", true);
                            $("#raggioricerca").val(msg.raggioServizi);
                            $("#nResultsServizi").val(msg.numeroRisultatiServizi);
                            $("#nResultsSensori").val(msg.numeroRisultatiSensori);
                            $("#nResultsBus").val(msg.numeroRisultatiBus);
                            $('#selezione').html(msg.actualSelection);
                            selezione = unescape(msg.actualSelection);
                            var openPins = msg.popupOpen;
                            if (textToSearch != "" && textToSearch != null) {
                                var nRes = msg.numeroRisultatiServizi;
                                if ((msg.actualSelection == "null" || msg.actualSelection == "") && (msg.categorie == "null" || msg.categorie == "") && (msg.coordinateSelezione == "null" || msg.coordinateSelezione == "")) {
                                    showResultsFreeSearch(textToSearch, nRes);
                                }
                                else {
                                    var range = msg.raggioServizi;
                                    stringaCategorie = msg.categorie;
                                    stringaCategorie = unescape(stringaCategorie);
                                    if (msg.actualSelection.indexOf("COMUNE di") != -1) {
                                        var selection = msg.nomeComune;
                                        var startingPoint = "municipality";
                                    }
                                    else {
                                        var selection = msg.coordinateSelezione;
                                        var startingPoint = "point";
                                    }
                                    $("#loading").show();
                                    svuotaLayers();
                                    $.ajax({
                                        data: {
                                            search: textToSearch,
                                            results: nRes,
                                            range: range,
                                            selection: selection,
                                            startingPoint: startingPoint,
                                            categorie: stringaCategorie
                                            // accessToken: MultiServiceMap.keycloak.token
                                        },
                                        url: ctx + "/ajax/json/get-services-by-text.jsp",
                                        type: "GET",
                                        dataType: 'json',
                                        async: true,
                                        success: function (data) {
                                            if (data.features.length > 0) {
                                                servicesLayer = L.geoJson(data, {
                                                    pointToLayer: function (feature, latlng) {
                                                        marker = showmarker(feature, latlng);
                                                        return marker;
                                                    },
                                                    onEachFeature: function (feature, layer) {
                                                        popupContent = "";
                                                        var divId = feature.id + "-" + feature.properties.tipo;
                                                        popupContent = popupContent + "<div id=\"" + divId + "\" ></div>";
                                                        layer.bindPopup(popupContent);
                                                    }
                                                }).addTo(map);
                                                if (mode == "embed") {
                                                    for (i in servicesLayer._layers) {
                                                        var uri = servicesLayer._layers[i].feature.properties.serviceUri;
                                                        if (include(openPins, uri))
                                                            servicesLayer._layers[i].openPopup();
                                                    }
                                                }
                                                var confiniMappa = servicesLayer.getBounds();
                                                map.fitBounds(confiniMappa, { padding: [50, 50] });
                                                $('#loading').hide();
                                            }
                                            else {
                                                $('#loading').hide();
                                                risultatiRicerca(0, 0, 0, 1, null, 0, 0, 0);
                                            }
                                        },
                                        error: function (request, status, error) {
                                            $('#loading').hide();
                                            console.log(error);
                                            alert('Error in searching ' + text + "\n The error is " + error);
                                        }
                                    });
                                }
                            }
                            else if (categorie != "null") { //no text search
                                var categorieArray = categorie.split(",");
                                var stringaCategorie = categorieArray.join(";");
                                stringaCategorie = stringaCategorie.replace("[", "");
                                stringaCategorie = stringaCategorie.replace("]", "");
                                stringaCategorie = stringaCategorie.replace(/\s+/g, '');
                                coordinateSelezione = unescape(msg.coordinateSelezione);
                                //$("#embed").show();
                                mostraServiziAJAX_new(stringaCategorie, msg.actualSelection, coordinateSelezione, msg.nomeComune, msg.numeroRisultatiServizi, msg.numeroRisultatiSensori, msg.numeroRisultatiBus, msg.raggioServizi, msg.raggioSensori, msg.raggioBus, openPins, null, "categorie");
                            }
                            else {
                            }
                        }
                    });
                }
            }
        }
        function showResultsFreeSearch(textToSearch, limit) {
            textToSearch = escape(textToSearch);
            $('#loading').show();
            $.ajax({
                data: {
                    search: textToSearch,
                    limit: limit
                    // accessToken: MultiServiceMap.keycloak.token
                },
                url: ctx + "/ajax/json/free-text-search.jsp",
                type: "GET",
                dataType: 'json',
                async: true,
                success: function (data) {
                    if (data.features.length > 0) {
                        servicesLayer = L.geoJson(data, {
                            pointToLayer: function (feature, latlng) {
                                marker = showmarker(feature, latlng);
                                return marker;
                            },
                            onEachFeature: function (feature, layer) {
                                popupContent = "";
                                var divId = feature.id + "-" + feature.properties.tipo;
                                popupContent = popupContent + "<div id=\"" + divId + "\" ></div>";
                                layer.bindPopup(popupContent);
                            }
                        }).addTo(map);
                        if (mode == "embed") {
                            for (i in servicesLayer._layers) {
                                var uri = servicesLayer._layers[i].feature.properties.serviceUri;
                                if (include(openPins, uri))
                                    servicesLayer._layers[i].openPopup();
                            }
                        }
                        var confiniMappa = servicesLayer.getBounds();
                        map.fitBounds(confiniMappa, { padding: [50, 50] });
                        $('#loading').hide();
                    }
                    else {
                        $('#loading').hide();
                        risultatiRicerca(0, 0, 0, 1, null, 0, 0, 0);
                    }
                },
                error: function (request, status, error) {
                    $('#loading').hide();
                    console.log(error);
                    alert('Error in searching ' + textFilter + "\n The error is " + error);
                }
            });
        }

        function showService(serviceUri) {

            if(msm_access_token!=""){
               
            $('#loading').show();

            $.ajax({
                data: {
                    serviceUri: serviceUri
                    // accessToken: MultiServiceMap.keycloak.token
                },
                // url: "api/service.jsp",
                url: selectedorgUrl,
                type: "GET",
                async: true,
                dataType: 'json',
                success: function (msg) {

                    if ("Service" in msg) {
                        msg = msg.Service;
                    }
                    if ("Sensor" in msg) {
                        msg = msg.Sensor;
                    }
                    if (msg != null && msg.meteo != null) {
                        // $.ajax({
                        //     url: "ajax/get-weather.jsp",
                        //     type: "GET",
                        //     async: true,
                        //     data: {
                        //         nomeComune: msg.meteo.location
                        //     },
                        //     success: function (msgMeteo) {
                        //         $('#info-aggiuntive .content').html(msgMeteo);
                        //         $('#loading').hide();
                        //     }
                        // });
                        var value = document.getElementById("org_selector").value;
                        if (value == "null") {
                            // value = superServiceMapApiUrl;
                            document.getElementById("org_selector").style.backgroundColor = "red";
                            alert('Please, select an organization!');
                        } else {
                            document.getElementById("org_selector").style.backgroundColor = "white";
                      
                        if (value == superServiceMapApiUrl) {
                            selectedorgUrl = value;
                            sample_coord_lat = '48.3708';
                            sample_coord_lon = '10.4589';
                        } else {
                            seperator = value.indexOf("|");
                            selectedorgUrl = value.substring(0, seperator);
                            center = value.substring(seperator + 1, value.length);
                            sample_coord_lat = center.substring(0, center.indexOf(","));
                            sample_coord_lon = center.substring(center.indexOf(",") + 1, center.length);
                        }

                        //fammi vedere il meteo
                        $.ajax({
                            // url: "ajax/get-weather.jsp",
                            url: selectedorgUrl + ctx + "location/",
                            type: "GET",
                            async: true,
                            headers: {'Authorization':'Bearer '+msm_access_token},
                            //dataType: 'json',
                            data: {
                                position: sample_coord_lat + ';' + sample_coord_lon
                                // accessToken: msm_access_token
                                // nomeComune: "FIRENZE"
                            },
                            success: function (msg) {
                                parameters["info"] = 'wheather';
                                municipalityUri = msg.municipalityUri;
                                getWeatherInfo(selectedorgUrl + ctx, municipalityUri);
                                //$('#loading').hide();
                                // $('#info-aggiuntive .content').html(msg);
                            }
                        });
                    }
                    } else if (msg != null && msg.features.length > 0 && msg.features[0].geometry.coordinates != undefined) {
                        var longService = msg.features[0].geometry.coordinates[0];
                        var latService = msg.features[0].geometry.coordinates[1];
                        servicesLayer = L.geoJson(msg, {
                            pointToLayer: function (feature, latlng) {
                                marker = showmarker(feature, latlng);
                                return marker;
                            },
                            onEachFeature: function (feature, layer) {
                                var tipo = feature.properties.tipo;
                                if (tipo == undefined)
                                    tipo = feature.properties.serviceType;
                                var divMM = feature.id + "-multimedia";
                                var multimediaResource = feature.properties.multimedia;
                                var htmlDiv;
                                if (multimediaResource != null) {
                                    var format = multimediaResource.substring(multimediaResource.length - 4);
                                    if (format == ".mp3") {
                                        htmlDiv = "<div id=\"" + divMM + "\"class=\"multimedia\"><audio controls class=\"audio-controls\"><source src=\"" + multimediaResource + "\" type=\"audio/mpeg\"></audio></div>";
                                    } else {
                                        if ((format == ".wav") || (format == ".ogg")) {
                                            htmlDiv = "<div id=\"" + divMM + "\"class=\"multimedia\"><audio controls class=\"audio-controls\"><source src=\"" + multimediaResource + "\" type=\"audio/" + format + "\"></audio></div>";
                                        } else {
                                            htmlDiv = "<div id=\"" + divMM + "\"class=\"multimedia\"><img src=\"" + multimediaResource + "\" width=\"80\" height=\"80\"></div>";
                                        }
                                    }
                                }
                                if (include(tipo, "@en"))
                                    tipo = tipo.replace("@en", "");
                                else
                                    tipo = tipo.replace("@it", "");
                                var divId = feature.id + "-" + tipo;
                                if (feature.properties.tipo != "fermata") {
                                    contenutoPopup = createContenutoPopup(feature, divId, feature.id);
                                    layer.addTo(map).bindPopup(contenutoPopup).openPopup();
                                    if (feature.multimedia != null) {

                                        //$(".leaflet-popup-content-wrapper").css("width", "300px"); 
                                        $('#' + divId).closest('div.leaflet-popup-content-wrapper').css("width", "300px");
                                    }
                                    if (feature.realtime != undefined) {
                                        mostraRealTimeData(divId + "-info", feature.realtime, serviceUri);
                                        //popup_fixpos(div);
                                    }
                                    popup_fixpos(divId);
                                }
                                else {
                                    var contenutoPopup = createContenutoPopup(feature, divId, feature.id);
                                    layer.addTo(map).bindPopup(contenutoPopup).openPopup();
                                }
                            }
                        });
                        map.setView(new L.LatLng(latService, longService), 16);
                    }
                    else {
                        alert("no info found for service " + serviceUri);
                    }
                    $('#loading').hide();
                },
                error: function (request, status, error) {
                    $('#loading').hide();
                    console.log(error);
                    alert('The service is private!');
                }
            });

        }else{
            alert('Please, sign-in first!');
        }
        }

        function showEmbedConfiguration(parameters) {
            var idConfiguration = parameters['idConf'];
            //var scale=parameters['scale'];
            //var translate=parameters['translate'];
            $.ajax({
                data: {
                    idConfiguration: idConfiguration,
                    scale: scale,
                    translate: translate
                    // accessToken: MultiServiceMap.keycloak.token
                },
                url: "api/embed/configuration.jsp",
                type: "GET",
                async: true,
                dataType: 'json',
                success: function (msg) {
                    if (msg.nomeProvincia != null) {
                        $("#elencoprovince").val(msg.nomeProvincia);
                        mostraElencoComuni(msg.nomeProvincia, msg.nomeComune);
                        $("#ui-id-2").click();
                    }
                    if (msg.line != null) {
                        getBusLines("embed");
                        //  mostraElencoAgenzie();
                        var value = document.getElementById("org_selector").value;
                        if (value == "null") {
                            // value = superServiceMapApiUrl;
                            document.getElementById("org_selector").style.backgroundColor = "red";
                            alert('Please, select an organization!');
                        } else {
                            document.getElementById("org_selector").style.backgroundColor = "white";
                       
                        if (value == superServiceMapApiUrl) {
                            selectedorgUrl = value;
                        } else {
                            seperator = value.indexOf("|");
                            selectedorgUrl = value.substring(0, seperator);
                        }

                        // if (selectedorgUrl == "") {
                        //     // document.getElementById("org_selector").style.backgroundColor="lightpink";
                        //     // alert('Please, select an organization!');
                        //     selectedorgUrl = "https://servicemap.disit.org/WebAppGrafo/api/v1/";
                        // } else {
                            mostraElencoAgenzie_api(selectedorgUrl);
                            $("#elencolinee").val(msg.line);
                            mostraElencoFermate(msg.line, msg.stop);
                            $("#ui-id-1").click();


                            if (msg.pins)
                                var pins = JSON.parse(msg.pins);
                            if (msg.popupOpen)
                                var openPopup = JSON.parse(msg.popupOpen);
                            $("#raggioricerca").val(msg.radius);
                            $("#numerorisultati").val(msg.numeroRisultati);
                            $('#selezione').html(msg.actualSelection);
                            var center = JSON.parse(msg.center);
                            map.setView(new L.LatLng(center.lat, center.lng), msg.zoom);
                            var openPins = [];
                            for (var i = 0; i < openPopup.length; i++) {
                                openPins.push(openPopup[i].id);
                            }
                            var weatherCity = msg.weatherCity;
                            if (weatherCity) {
                                // $.ajax({
                                //     url: "ajax/get-weather.jsp",
                                //     type: "GET",
                                //     async: true,
                                //     data: {
                                //         nomeComune: weatherCity
                                //     },
                                //     success: function (msg) {
                                //         $('#info-aggiuntive .content').html(msg);
                                //     }
                                // });
                                // var value = document.getElementById("org_selector").value;
                                // if (value == "null") {
                                //     // value = superServiceMapApiUrl;
                                //     document.getElementById("org_selector").style.backgroundColor = "red";
                                //     alert('Please, select an organization!');
                                // } else {
                                    // document.getElementById("org_selector").style.backgroundColor = "white";
                               
                                if (value == superServiceMapApiUrl) {
                                    selectedorgUrl = value;
                                    sample_coord_lat = '48.3708';
                                    sample_coord_lon = '10.4589';
                                } else {
                                    seperator = value.indexOf("|");
                                    selectedorgUrl = value.substring(0, seperator);
                                    center = value.substring(seperator + 1, value.length);
                                    sample_coord_lat = center.substring(0, center.indexOf(","));
                                    sample_coord_lon = center.substring(center.indexOf(",") + 1, center.length);
                                }

                                //fammi vedere il meteo
                                $.ajax({
                                    // url: "ajax/get-weather.jsp",
                                    url: selectedorgUrl + ctx + "location/",
                                    type: "GET",
                                    async: true,
                                    headers: {'Authorization':'Bearer '+msm_access_token},
                                    //dataType: 'json',
                                    data: {
                                        position: sample_coord_lat + ';' + sample_coord_lon
                                        // accessToken: msm_access_token
                                        // nomeComune: "FIRENZE"
                                    },
                                    success: function (msg) {
                                        municipalityUri = msg.municipalityUri;
                                        getWeatherInfo(selectedorgUrl + ctx, municipalityUri);
                                        //$('#loading').hide();
                                        // $('#info-aggiuntive .content').html(msg);
                                    }
                                });
                            // }
                            }
                            var categorie = msg.categorie;
                            //categorie=categorie.substr(1,categorie.length-1);
                            $("#categorie :not(:checked)").each(function () {
                                var category = $(this).val();
                                if (categorie.indexOf(category) > -1)
                                    $(this).attr("checked", true);
                            });
                            servicesLayer = L.geoJson(pins, {
                                pointToLayer: function (feature, latlng) {
                                    marker = showmarker(feature, latlng);
                                    return marker;
                                },
                                onEachFeature: function (feature, layer) {

                                    var divId = feature.id + "-" + feature.properties.tipo;
                                    if (feature.properties.tipo != "fermata") {
                                        contenutoPopup = "<h3>" + feature.properties.name + "</h3>";
                                        contenutoPopup = contenutoPopup + "Serviceuri: <a href='" + logEndPoint + feature.properties.serviceUri + "' title='Linked Open Graph' target='_blank'>" + feature.properties.serviceUri + "</a><br />";
                                        contenutoPopup = contenutoPopup + "Tipologia: " + feature.properties.tipo + "<br />";
                                        if (feature.properties.email != "" && feature.properties.email)
                                            contenutoPopup = contenutoPopup + "Email: " + feature.properties.email + "<br />";
                                        if (feature.properties.indirizzo != "")
                                            contenutoPopup = contenutoPopup + "Indirizzo: " + feature.properties.indirizzo;
                                        if (feature.properties.numero != "" && feature.properties.numero)
                                            contenutoPopup = contenutoPopup + ", " + feature.properties.numero + "<br />";
                                        else
                                            contenutoPopup = contenutoPopup + "<br />";
                                        if (feature.properties.note != "" && feature.properties.note)
                                            contenutoPopup = contenutoPopup + "Note: " + feature.properties.note + "<br />";
                                        contenutoPopup = contenutoPopup + "<div id=\"" + divId + "\" ></div>";
                                        if (include(openPins, feature.id))
                                            layer.addTo(map).bindPopup(contenutoPopup).openPopup();
                                        else
                                            layer.addTo(map).bindPopup(contenutoPopup);
                                    }
                                    else {
                                        var divLinee = divId + "-linee";
                                        var contenutoPopup = "<h3>FERMATA : " + feature.properties.popupContent + "</h3>";
                                        contenutoPopup = contenutoPopup + "Serviceuri: <a href='" + logEndPoint + feature.properties.serviceUri + "' title='Linked Open Graph' target='_blank'>" + feature.properties.serviceUri + "</a><br />";
                                        contenutoPopup += "<div id=\"" + divLinee + "\" ></div>";
                                        contenutoPopup = contenutoPopup + "<div id=\"" + divId + "\" ></div>";
                                        if (include(openPins, feature.id))
                                            layer.addTo(map).bindPopup(contenutoPopup).openPopup();
                                        else
                                            layer.addTo(map).bindPopup(contenutoPopup);
                                    }
                                }
                            });
                            $("#loading").hide();
                        // }
                    }
                    }
                }
            });
        }

        /***  codice per mantenere aperto piÃÂ¹ di un popup per volta ***/
        L.Map = L.Map.extend({
            openPopup: function (popup) {
                //        this.closePopup();  // just comment this
                this._popup = popup;
                return this.addLayer(popup);
            }

        });
        // CREAZIONE MAPPA CENTRATA NEL PUNTO
        //commentato marco
        //var map = L.map('map').setView([43.3555664, 11.0290384], 8);

        // SCELTA DEL TILE LAYER ED IMPOSTAZIONE DEI PARAMETRI DI DEFAULT
        /*commentato marco
         L.tileLayer('http://c.tiles.mapbox.com/v3/examples.map-szwdot65/{z}/{x}/{y}.png', { // NON MALE
         //L.tileLayer('http://{s}.tile.cloudmade.com/{key}/22677/256/{z}/{x}/{y}.png', {
         //L.tileLayer('http://a.www.toolserver.org/tiles/bw-mapnik/{z}/{x}/{y}.png', {
         //L.tileLayer('http://a.tile.openstreetmap.org/{z}/{x}/{y}.png', {
         //L.tileLayer('http://tilesworld1.waze.com/tiles/{z}/{x}/{y}.png', {
         //		L.tileLayer('http://maps.yimg.com/hx/tl?v=4.4&x={x}&y={y}&z={z}', {
         //L.tileLayer('http://a.tiles.mapbox.com/v3/examples.map-bestlap85.h67h4hc2/{z}/{x}/{y}.png', { MAPBOX MA NON FUNZIA
         //L.tileLayer('http://{s}.tile.cloudmade.com/1a1b06b230af4efdbb989ea99e9841af/998/256/{z}/{x}/{y}.png', { 
         //	L.tileLayer('http://{s}.tile.cloudmade.com/1a1b06b230af4efdbb989ea99e9841af/121900/256/{z}/{x}/{y}.png', { 
         attribution: 'Map data &copy; 2011 OpenStreetMap contributors, Imagery &copy; 2012 CloudMade',
         key: 'BC9A493B41014CAABB98F0471D759707',
         minZoom: 8
         }).addTo(map);
         
         *fine commento marco
         */

        //codice per gestione layers
        //var osm = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'});
        //http://otile1.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.jpg
        //http://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png
        //http://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png
        //http://a.tile.thunderforest.com/outdoors/{z}/{x}/{y}.png
        //http://a.tile.stamen.com/toner/{z}/{x}/{y}.png
        //http://a.tile.thunderforest.com/landscape/{z}/{x}/{y}.png
        //var osm = L.tileLayer('http://a.tile.thunderforest.com/landscape/{z}/{x}/{y}.png', {attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'});

        var mbAttr = 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery &copy; <a href="http://mapbox.com">Mapbox</a>',
            mbUrl = 'https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoicGJlbGxpbmkiLCJhIjoiNTQxZDNmNDY0NGZjYTk3YjlkNTAzNWQwNzc0NzQwYTcifQ.CNfaDbrJLPq14I30N1EqHg';
        var streets = L.tileLayer(mbUrl, { id: 'mapbox/streets-v11', attribution: mbAttr, tileSize: 512, zoomOffset: -1 }),
            satellite = L.tileLayer(mbUrl, { id: 'mapbox/satellite-streets-v11', attribution: mbAttr, tileSize: 512, zoomOffset: -1 }),
            grayscale = L.tileLayer(mbUrl, { id: 'mapbox/light-v10', attribution: mbAttr, tileSize: 512, zoomOffset: -1 });
        var map = L.map('map', {
            center: [43.3555664, 11.0290384],
            zoom: 8,
            layers: [streets]
        });
        var baseMaps = {
            "Streets": streets,
            "Satellite": satellite,
            "Grayscale": grayscale
        };
        var toggleMap = L.control.layers(baseMaps, null, { position: 'bottomright', width: '50px', height: '50px' });
        toggleMap.addTo(map);
        if (getUrlParameter("map") == "streets") {
            map.removeLayer(satellite);
            map.addLayer(streets);
        }
        else if (getUrlParameter("map") == "grayscale") {
            map.removeLayer(satellite);
            map.addLayer(grayscale);
        }

        // DEFINIZIONE DEI CONFINI MASSIMI DELLA MAPPA
        /*if(mode!="query") {
          var bounds = new L.LatLngBounds(new L.LatLng(41.7, 8.4), new L.LatLng(44.930222, 13.4));
          map.setMaxBounds(bounds);
        }*/

        // GENERAZIONE DEI LAYER PRINCIPALI
        var busStopsLayer = new L.LayerGroup();
        var servicesLayer = new L.LayerGroup();
        var eventLayer = new L.LayerGroup();
        var clickLayer = new L.LayerGroup();
        var GPSLayer = new L.LayerGroup();
        // AGGIUNTA DEL PLUGIN PER LA GEOLOCALIZZAZIONE
        var GPSControl = new L.Control.Gps({
            maxZoom: 16,
            style: null
        });
        var oms = new OverlappingMarkerSpiderfier(map, { keepSpiderfied: true });
        //map.addControl(GPSControl);
        //$("#currentPosition").add(GPSControl);+

        // ASSOCIA FUNZIONI AGGIUNTIVE ALL'APERTURA DI UN POPUP SU PARTICOLARI TIPI DI DATI
        var last_marker = null;
        map.on('popupopen', function (e) {
            $('#raggioricerca').prop('disabled', false);
            $('#raggioricerca_t').prop('disabled', false);
            $('#PublicTransportLine').prop('disabled', false);
            $('#nResultsServizi').prop('disabled', false);
            $('#nResultsSensori').prop('disabled', false);
            $('#nResultsBus').prop('disabled', false);
            $('#approximativeAddress').html('');
            var markerPopup = e.popup._source;
            //aggiunto
            var idServizio = markerPopup.feature.id;
            currentServiceUri = markerPopup.feature.properties.serviceUri;
            var tipoServizio = markerPopup.feature.properties.tipo;
            if (tipoServizio == undefined)
                //   tipoServizio=markerPopup.feature.properties.serviceType;
                tipoServizio = 'fermata';
            var serviceType = markerPopup.feature.properties.serviceType;
            var nome = markerPopup.feature.properties.name;
            var divId = idServizio + "-" + tipoServizio;//assegnazione degli id ai div relativi ai servizi

            // //Ala
            // if(tipoServizio == 'fermata'){
            //     divId = idServizio + "-undefined";//assegnazione degli id ai div relativi ai servizi
            // }

            var coordinates = markerPopup.feature.geometry.coordinates;
            if (tipoServizio == 'fermata') {
                $('#' + divId).closest('div.leaflet-popup-content-wrapper').css("width", "530px");
            } else {
                $('#' + divId).closest('div.leaflet-popup-content-wrapper').css("width", "500px");
            }
            popup_fixpos(divId);
            if (mode != "embed") {
                //selezione = 'Servizio: ' + markerPopup.feature.properties.name;
                if (tipoServizio == 'fermata') {
                    selezione = 'Bus Stop: ' + markerPopup.feature.properties.name;
                } else {
                    selezione = 'Service: ' + markerPopup.feature.properties.name;
                }
                $('#selezione').html(selezione);
                clickLayer.clearLayers();
                // CLICK SUL MARKER - Viene evidenziato il SELECTED marker, e settata l'icona di default al precedente selezionato.                                
                $(markerPopup._icon).siblings().removeClass('selected');
                if (last_marker != null && last_marker.getLatLng() != markerPopup.getLatLng()) {
                    if (last_marker.feature.properties.serviceType == "") {
                        var serviceIcon = "generic";
                    } else {
                        var serviceIcon = last_marker.feature.properties.serviceType;
                        //Michela
                        if ((serviceType == "TransferServiceAndRenting_BusStop" || serviceType == "Tram_stops" ||
                            serviceType == "Train_station" || serviceType == "Ferry_stop")) {
                            if (last_marker.feature.properties.agency)
                                serviceIcon = serviceIcon + "_" + last_marker.feature.properties.agency.toLowerCase().replace(/\./g, "").replace(/&/g, "").replace(/ÃÂ¹/g, "u").replace(/ÃÂ /g, "a").replace(/ /g, "");
                            else
                                serviceIcon = serviceIcon + "_ataflinea";
                        }
                    }
                    if (last_marker.feature.properties.serviceType != "bus_real_time") {

                        var def_icon = L.icon({

                            //iconUrl: ctx + '/img/mapicons/' + last_marker.feature.properties.serviceType + '.png',
                            //iconRetinaUrl: ctx + '/img/mapicons/' + last_marker.feature.properties.serviceType + '.png',
                            iconUrl: ctx + 'img/mapicons/' + serviceIcon + '.png',
                            iconRetinaUrl: ctx + 'img/mapicons/' + serviceIcon + '.png',
                            iconSize: [26, 29],
                            iconAnchor: [13, 29],
                        });
                        //popupAnchor: [0, -27],});
                        last_marker.setIcon(def_icon);
                    }
                    else {
                        var def_icon = L.icon({
                            iconUrl: ctx + 'img/mapicons/' + serviceIcon + '.gif',
                            iconRetinaUrl: ctx + 'img/mapicons/' + serviceIcon + '.gif',
                            iconSize: [15, 15],
                            iconAnchor: [7, 15],
                            popupAnchor: [0, -7],
                        });
                        last_marker.setIcon(def_icon);
                    }
                }
                $(markerPopup._icon).addClass('selected');
                last_marker = markerPopup;
            }
            loadServiceInfo(currentServiceUri, divId, idServizio, coordinates);
            coordinateSelezione = markerPopup.feature.geometry.coordinates[1] + ";" + markerPopup.feature.geometry.coordinates[0];
            listOfPopUpOpen.push(currentServiceUri);
        });
        map.on('popupclose', function (e) {
            var popupToRemove = e.popup._source;
            for (var i = listOfPopUpOpen.length - 1; i >= 0; i--) {
                if (listOfPopUpOpen[i] === popupToRemove.feature.properties.serviceUri) {
                    listOfPopUpOpen.splice(i, 1);
                }
            }
        });
        // AL CLICK CERCO L'INDIRIZZO APPROSSIMATIVO	
        map.on('click', function (e) {

            // mapLatLngClick(e.latlng);
            if (selectedorgUrl != 'null') {
                var zoom;
                if(superServiceMapApiUrl!=selectedorgUrl){
                 zoom=getOrgZoomLevel(selectedorgUrl);
                }
                
                mapLatLngClick_api(e.latlng, false, zoom);
            } else {
                // value = superServiceMapApiUrl;
                document.getElementById("org_selector").style.backgroundColor = "red";
                alert('Please, select an organization!');
            }
        });
    
        var selezioneAttiva = false;
        var ricercaInCorso = false;
        var logEndPoint = "http://log.disit.org/service/?sparql=http://servicemap.disit.orgsparql&uri=";

        function init() {

            changeLanguage('ENG');
            // CREO LE TABS JQUERY UI NEL MENU IN ALTO
            $("#tabs").tabs();
            $("#tabs-servizi").tabs();
            $("#path_date").datepicker({ dateFormat: "yy-mm-dd" });
            $("#path_time").timepicker({ timeFormat: "H:i", step: 10 });
            //$("#fancytree").fancytree();

            /* //fancy tree INIZIO
            $.ajax({
                    url: "ajax/json/taxonomy.jsp",
                    type: "GET",
                    async: true,
                    dataType: 'json',
                    data: {
                        lang: "ENG",
                    },
                    success: function (response) {
                      taxonomy_ENG = response;
                    }
                });
            $.ajax({
                    url: "ajax/json/taxonomy.jsp",
                    type: "GET",
                    async: true,
                    dataType: 'json',
                    data: {
                        lang: "ITA",
                    },
                    success: function (response) {
                      taxonomy_ITA = response;
                    }
                });
            //fancy tree fine
            */
            $.widget("ui.autocomplete", $.ui.autocomplete, {
                _renderItem: function (ul, item) {
                    var icon = item.properties.serviceType.replace(" ", "_");
                    if (icon == "StreetNumber" || icon == "Municipality")
                        icon = "generic";
                    return $("<li>")
                        .attr("data-value", item.value)
                        .append("<img src=\"" + ctx + "img/mapicons/" + icon + ".png\" height=\"23\" width=\"20\" align=\"top\">" + item.label)
                        .appendTo(ul);
                }
            });
            
            $("#quick-search").autocomplete({ source: quickSearchCheck, select: quickSearchSelect });
            if (mode == "query" || mode == "embed" || mode == "bus-position") {
                var url = document.URL;
                var queryString = url.substring(url.indexOf('?') + 1);
                var parameters = parseUrlQuery(queryString);
                $("#embed.menu").hide();
                $("#save").hide();
                // $("#saveQuery").hide();
                // $("#saveQuerySearch").hide();
                var controls = parameters["controls"];
                if (mode == "query" && controls == undefined)
                    controls = "collapsed";
                if (controls == "false" || controls == "hidden" || controls == undefined) {
                    //michela SE NON vedo il menu DEVO METTERE i logo

                    $("#menu-dx").hide();
                    $("#menu-alto").hide();//al posto di questo devo mettere i logo
                    $("#menu-alto-hidden").show();

                    $("#embed.menu").hide();
                }
                else if (controls == "collapsed") {
                    // $("#menu-dx .header").click();
                    // $("#menu-alto .header").click();
                }
                var info = parameters["info"];
                if (info == "false" || info == "hidden" /*|| info ==undefined*/) {
                    $("#info-aggiuntive").hide();
                }
                else if (info == "collapsed") {
                    $("#info-aggiuntive .header").click();
                }
                if (parameters["description"] == "false") {
                    $("#queryBox").hide();
                }
                setTimeout(function waitMapSize() {
                    if (map.getSize().y > 0) {
                        if (parameters["showBusPosition"] == "true" || mode == "bus-position") {
                            mostraAutobusRT(true, parameters["agency"], parameters["line"]);
                        } else {
                            showResults(parameters);
                        }
                    } else
                        setTimeout(waitMapSize, 500);
                }, 500);
            }
            $("#raggioricerca").change(function () {
                var selected = $(this).val();
                $("#geosearch").prop("disabled", selected != "geo");
            });
            $("#geosearch").change(function () {
                clickLayer.clearLayers();
                var selected = $(this).val();
                if (selected != "select")
                    $.ajax({
                        url: "ajax/json/get-geometry.jsp",
                        type: "GET",
                        async: true,
                        dataType: 'json',
                        data: {
                            label: selected
                            // accessToken: MultiServiceMap.keycloak.token
                        },
                        success: function (response) {
                            var wkt = new Wkt.Wkt();
                            wkt.read(response.wkt);
                            var obj = wkt.toObject();
                            obj.addTo(clickLayer);
                            clickLayer.addTo(map);
                            map.fitBounds(clickLayer.getLayers()[0].getBounds());
                        }
                    });
            });
        }

        var comuneChoice;
        var selezione;
        var coordinateSelezione;
        var numeroRisultati;
        // MOSTRA ELENCO COMUNI DI UNA PROVINCIA
        function mostraElencoComuni(selectOption, nomeComune) {
            if ($("#elencoprovince").val() != null) {
                //	if (selectOption.options.selectedIndex != 0){	
                $('#elencolinee')[0].options.selectedIndex = 0;
                $('#elencofermate').html('<option value=""> - Select a Bus Stop - </option>');
                //$('#loading').show();
                $.ajax({
                    url: "ajax/get-municipality-list.jsp",
                    type: "GET",
                    async: true,
                    //dataType: 'json',
                    data: {
                        nomeProvincia: $("#elencoprovince").val()
                        // accessToken: MultiServiceMap.keycloak.token
                        // nomeProvincia: selectOption.options[selectOption.options.selectedIndex].value
                    },
                    success: function (msg) {
                        $('#elencocomuni').html(msg);
                        if (mode == "embed" || mode == "query") {
                            $('#elencocomuni').val(nomeComune);
                            //$('#loading').hide();
                        }
                        else
                            $('#loading').hide();
                    }
                });
            }
        }

        /*function loadServiceInfo(uri, div) {
         $.ajax({
         data: {
         serviceUri: uri
         },
         url: "api/service.jsp",
         type: "GET",
         async: true,
         dataType: 'json',
         success: function (data) {
         if (data.features.length > 0) {
         var tipo = data.features[0].properties.tipo;
         selezione = 'Servizio: ' + data.features[0].properties.nome;
         $('#selezione').html(selezione);
         var divMM = data.features[0].id + "-multimedia";
         var multimediaResource = data.features[0].properties.multimedia;
         var htmlDiv;
         if (multimediaResource != null)
         {
         var format = multimediaResource.substring(multimediaResource.length -4);
         if (format == ".mp3"){
         htmlDiv = "<div id=\"" + divMM + "\"class=\"multimedia\"><audio controls class=\"audio-controls\"><source src=\""+ multimediaResource +"\" type=\"audio/mpeg\"></audio></div>";
         }else{
         if ((format == ".wav") || (format == ".ogg")){
         htmlDiv = "<div id=\"" + divMM + "\"class=\"multimedia\"><audio controls class=\"audio-controls\"><source src=\""+ multimediaResource +"\" type=\"audio/"+ format+"\"></audio></div>";  
         }else{
         htmlDiv = "<div id=\"" + divMM + "\"class=\"multimedia\"><img src=\"" + multimediaResource + "\" width=\"80\" height=\"80\"></div>";   
         }
         }
         }
         if (include(tipo, "@en"))
         tipo = tipo.replace("@en", "");
         else
         tipo = tipo.replace("@it", "");
         var divId = data.features[0].id + "-" + tipo;
         if (data.features[0].properties.tipo != "fermata") {
         contenutoPopup = "<h3>" + data.features[0].properties.nome + "</h3>";
         contenutoPopup = contenutoPopup + "<a href='" + logEndPoint + data.features[0].properties.serviceUri + "' title='Linked Open Graph' target='_blank'>LINKED OPEN GRAPH</a><br />";
         contenutoPopup = contenutoPopup + "<b>Tipologia:</b> " + tipo + "<br />";
         var feature = data.features[0];
         if (data.features[0].properties.email != "" && data.features[0].properties.email)
         contenutoPopup = contenutoPopup + "<b>Email:</b><a href=\"mailto:"+feature.properties.email+"?Subject=information request\" target=\"_top\"> " + feature.properties.email + "</a><br />";
         
         if (feature.properties.website != "" && feature.properties.website)
         contenutoPopup = contenutoPopup + "<b>Website:</b><a href=\"http\://"+ feature.properties.website + "\" target=\"_blank\" title=\""+feature.properties.nome+" - website\"> " + feature.properties.website + "</a><br />";
         if (feature.properties.phone != "" && feature.properties.phone)
         contenutoPopup = contenutoPopup + "<b>Phone:</b> " + feature.properties.phone + "<br />";
         if (feature.properties.fax != "" && feature.properties.fax)
         contenutoPopup = contenutoPopup + "<b>Fax:</b> " + feature.properties.fax + "<br />";
         if (data.features[0].properties.indirizzo != "")
         contenutoPopup = contenutoPopup + "<b>Indirizzo:</b> " + data.features[0].properties.indirizzo;
         if (data.features[0].properties.numero != "" && data.features[0].properties.numero)
         contenutoPopup = contenutoPopup + ", " + data.features[0].properties.numero + "<br />";
         else
         contenutoPopup = contenutoPopup + "<br />";
         if (feature.properties.cap != "" && feature.properties.cap)
         contenutoPopup = contenutoPopup + "<b>Cap:</b> " + feature.properties.cap + "<br />";
         if (feature.properties.city != "" && feature.properties.city)
         contenutoPopup = contenutoPopup + "<b>City:</b> " + feature.properties.city + "<br />";
         if (feature.properties.province != "" && feature.properties.province)
         contenutoPopup = contenutoPopup + "<b>Prov.:</b> " + feature.properties.province + "<br />";
         if (data.features[0].properties.multimedia != "" && data.features[0].properties.multimedia) {
         contenutoPopup = contenutoPopup + "<b>Multimedia Content:</b></br>" +htmlDiv;
         }
         if (data.features[0].properties.description != "" && data.features[0].properties.description) {
         if (include(data.features[0].properties.description, "@it"))
         data.features[0].properties.description = data.features[0].properties.description.replace("@it", "");
         contenutoPopup = contenutoPopup + "Description: " + data.features[0].properties.description + "<br />";
         }
         if (data.features[0].properties.note != "" && data.features[0].properties.note)
         contenutoPopup = contenutoPopup + "<b>Note:</b> " + data.features[0].properties.note + "<br />";
         
         contenutoPopup = contenutoPopup + "<div id=\"" + divId + "\" ></div>";
         var name = data.features[0].properties.nome;
         nameEscaped = escape(name);
         var divSavePin = "savePin-" + data.features[0].id;
         contenutoPopup = contenutoPopup + "<div id=\"" + divSavePin + "\" class=\"savePin\" onclick=save_handler('" + data.features[0].properties.tipo + "','" + data.features[0].properties.serviceUri + "','" + nameEscaped + "')></div>";
         //layer.addTo(map).bindPopup(contenutoPopup).openPopup();
         if (tipo == 'parcheggio_auto' || tipo == "parcheggio_Coperto" || tipo == "parcheggi_all'aperto" || tipo == "car_park@en") {
         mostraParcheggioAJAX(name, divId);
         }
         if (tipo == 'sensore') {
         mostraSensoreAJAX(name, divId);
         }
         $("#" + div).html(contenutoPopup);
         if (multimediaResource != "" && multimediaResource != null)
         $(".leaflet-popup-content-wrapper").css("width", "300px");
         popup_fixpos(div);
         } else {
         var divLinee = divId + "-linee";
         var contenutoPopup = "<h3>FERMATA : " + data.features[0].properties.nome + "</h3>";
         contenutoPopup = contenutoPopup + "<a href='" + logEndPoint + data.features[0].properties.serviceUri + "' title='Linked Open Graph' target='_blank'>LINKED OPEN GRAPH</a><br />";
         contenutoPopup = contenutoPopup + "<div id=\"" + divLinee + "\" ></div>";
         contenutoPopup = contenutoPopup + "<div id=\"" + divId + "\" ></div>";
         var divSavePin = "savePin-" + data.features[0].id;
         var name = data.features[0].properties.nome;
         nameEscaped = escape(name);
         contenutoPopup = contenutoPopup + "<div id=\"" + divSavePin + "\" class=\"savePin\" onclick=save_handler('" + data.features[0].properties.tipo + "','" + data.features[0].properties.serviceUri + "','" + nameEscaped + "')></div>";
         $("#" + div).html(contenutoPopup);
         popup_fixpos(div);
         mostraAVMAJAX(name, divId);
         mostraLineeBusAJAX(name, divLinee);
         }
         } else {
         contenutoPopup = "No info sul servizio " + uri;
         $("#" + div).html(contenutoPopup);
         popup_fixpos(div);
         }
         }
         });
         }*/
        // FUNZIONI DI RICERCA PRINCIPALI
        function mostraLineeBusAJAX(uriFermata, divLinee, divRoute) {

            $.ajax({
                // url: "ajax/get-lines-of-stop.jsp",
                url: selectedorgUrl + ctx + "/",
                type: "GET",
                async: true,
                headers: {'Authorization':'Bearer '+msm_access_token},
                //dataType: 'json',
                data: {
                    // uriFermata: uriFermata,
                    serviceUri: uriFermata
                    // accessToken: msm_access_token
                    // divRoute: divRoute,
                },
                success: function (msg) {

                    var divLine = document.getElementById(divLinee);
                    var bold_elem = document.createElement("b");
                    var t = document.createTextNode("Lines:");
                    bold_elem.appendChild(t);
                    divLine.appendChild(bold_elem);
                    var linecount = 0;
                    var divLine_innerHtml = "";
                    divLine_innerHtml = '<div class="infoLinee"><b>Lines:</b><br><table><tr>';

                    while (linecount < msg.busLines.results.bindings.length) {

                        var line = "";

                        if (msg.busLines.results.bindings[linecount].busLine.value != null)
                            line = msg.busLines.results.bindings[linecount].busLine.value;
                        else
                            line = msg.busLines.results.bindings[linecount].lineDesc.value;

                        var LineUri = msg.busLines.results.bindings[linecount].lineUri.value;
                        var ag = msg.BusStop.features[0].properties.agencyUri;

                        // divRoute=encodeURIComponent(divRoute);
                        // uriFermata=encodeURIComponent(uriFermata);

                        divLine_innerHtml += "<td onclick=\"showRoute('" + ag + "','" + LineUri + "','" + uriFermata + "','" + divRoute + "')\">" + line + "</td>";

                        //             //out.println("<td onclick='showLinea(\""+ idLine +"\")'>" + idLine + "</td>");

                        linecount++;
                    }
                    divLine_innerHtml += '</tr></table></div>';
                    $("#" + divLinee).html(divLine_innerHtml);
                    popup_fixpos(divLinee);
                    //$('#info-aggiuntive .content').html(msg);
                }
            });
        }

        //ignore get-avm.jsp (according to Piero)
        // function mostraAVMAJAX(nomeFermata, divId) {
        //     var value = document.getElementById("org_selector").value;

        //     if(value==superServiceMapApiUrl){
        //         selectedorgUrl=value;
        //     }else{
        //         seperator=value.indexOf("|");
        //         selectedorgUrl=value.substring(0,seperator);
        //     }  
        //     $('#loading').show();
        //     $.ajax({
        //         url: "/ajax/get-avm.jsp",
        //         // url: selectedorgUrl+"/tpl/bus-routes/",
        //         type: "GET",
        //         async: true,
        //         //dataType: 'json',
        //         data: {
        //             nomeFermata: nomeFermata
        //             // busStopName: nomeFermata
        //         },
        //         success: function (msg) {
        //             // alert(divId);
        //             $("#" + divId).html(msg);
        //             //$('#info-aggiuntive .content').html(msg);
        //             popup_fixpos(divId);
        //             $('#loading').hide();
        //         }
        //     });
        // }
        function mostraParcheggioAJAX(nomeParcheggio, divId) {
            $.ajax({
                url: "ajax/get-parking-status.jsp",
                type: "GET",
                async: true,
                //dataType: 'json',
                data: {
                    nomeParcheggio: nomeParcheggio
                    // accessToken: MultiServiceMap.keycloak.token
                },
                success: function (msg) {
                    $("#" + divId).html(msg);
                    //$('#info-aggiuntive .content').html(msg);
                    popup_fixpos(divId);
                }
            });
        }
        //MICHELA 
        function mostraOrariAJAX(TPLStopUri, divId) {//uri exnomefermata
            // alert(TPLStopUri);
            $.ajax({
                // url: "ajax/json/get-timetable.jsp",
                url: selectedorgUrl + ctx + "/",
                type: "GET",
                async: true,
                headers: {'Authorization':'Bearer '+msm_access_token},
                dataType: 'json',
                data: {
                    serviceUri: TPLStopUri
                    // accessToken: msm_access_token
                },
                success: function (msg) {
                    //alert(msg);
                    //$("#" + divId).html(msg);//ok 
                    msg.idtable = "timetable-" + divId;
                    ViewManager.render(msg, "#" + divId, "BusStop");

                    $.fn.dataTable.moment('HH:MM:ss yyyy-mm-dd');
                    $("#" + msg.idtable).DataTable({
                        "columnDefs": [
                            { "width": "60px", "targets": 0 },
                            { "type": "date", "targets": 0 }],
                        "autowidth": true,
                        "order": [[0, "asc"]],
                        "scrollY": "200px",
                        "scrollCollapse": true,
                        "lengthMenu": [[10, 25, 50, 100, 200], [10, 25, 50, 100, 200]],// [[10, 25, 50, 100, 200], [10, 25, 50, 100, 200]],
                        "pagingType": "numbers",
                        "language": {
                            "lengthMenu": "<span name=\"lbl\" caption=\"timetable_display\">Display </span>" + "_MENU_" +
                                "<span name=\"lbl\" caption=\"timetable_records\"> Bus per page</span>",
                            "zeroRecords": "Nothing found - sorry",
                            "info": "<span name=\"lbl\" caption=\"timetable_showing\">Showing page</span>" + " _PAGE_ " +
                                "<span name=\"lbl\" caption=\"timetable_of\">of</span>" + " _PAGES_",
                            "infoEmpty": "No records available",
                            "infoFiltered": "(filtered from _MAX_ total records)",
                            "search": "<span name=\"lbl\" caption=\"timetable_search\">Search</span>" + ":",
                        }
                    });
                    //$("#" + divId).html(parseJSON(msg));
                    //$('#info-aggiuntive .content').html(msg);
                    popup_fixpos(divId);
                }
            });
        }
        function mostraSensoreAJAX(nomeSensore, divId) {
            $.ajax({
                url: "ajax/get-sensor-data.jsp",
                type: "GET",
                async: true,
                //dataType: 'json',
                data: {
                    nomeSensore: nomeSensore
                    // accessToken: MultiServiceMap.keycloak.token
                },
                success: function (msg) {
                    $("#" + divId).html(msg);
                    popup_fixpos(divId);
                    //$('#info-aggiuntive .content').html(msg);

                }
                // timeout:10000
            });
        }

        function updateSelection() {
            comuneChoice = $('#elencocomuni').val();
            selezione = "COMUNE di " + comuneChoice;
            $('#nResultsServizi').prop('disabled', false);
            $('#nResultsSensori').prop('disabled', false);
            $('#nResultsBus').prop('disabled', false);
            $('#selezione').html(selezione);
            coordinateSelezione = "";
            $('#raggioricerca')[0].options.selectedIndex = 0;
            $('#raggioricerca').prop('disabled', 'disabled');
            $('#raggioricerca_t')[0].options.selectedIndex = 0;
            $('#raggioricerca_t').prop('disabled', 'disabled');
            $('#approximativeAddress').html('');
            if ($('#PublicTransportLine').prop('checked')) {
                if ($('#PublicTransportLine').prop('checked', false));
            }
            $('#PublicTransportLine').prop('disabled', 'disabled');
            // $.ajax({
            //     url: "ajax/get-weather.jsp",
            //     type: "GET",
            //     async: true,
            //     //dataType: 'json',
            //     data: {
            //         nomeComune: comuneChoice
            //     },
            //     success: function (msg) {
            //         $('#info-aggiuntive .content').html(msg);
            //     }
            // });
            var value = document.getElementById("org_selector").value;
            if (value == "null") {
                // value = superServiceMapApiUrl;
                document.getElementById("org_selector").style.backgroundColor = "red";
                alert('Please, select an organization!');
            }else{
            if (value == superServiceMapApiUrl) {
                selectedorgUrl = value;
                sample_coord_lat = '48.3708';
                sample_coord_lon = '10.4589';
            } else {
                seperator = value.indexOf("|");
                selectedorgUrl = value.substring(0, seperator);
                center = value.substring(seperator + 1, value.length);
                sample_coord_lat = center.substring(0, center.indexOf(","));
                sample_coord_lon = center.substring(center.indexOf(",") + 1, center.length);
            }

            //fammi vedere il meteo
            $.ajax({
                // url: "ajax/get-weather.jsp",
                url: selectedorgUrl + ctx + "location/",
                type: "GET",
                async: true,
                headers: {'Authorization':'Bearer '+msm_access_token},
                //dataType: 'json',
                data: {
                    position: sample_coord_lat + ';' + sample_coord_lon
                    // accessToken: msm_access_token
                    // nomeComune: "FIRENZE"
                },
                success: function (msg) {
                    municipalityUri = msg.municipalityUri;
                    getWeatherInfo(selectedorgUrl + ctx, municipalityUri);
                    //$('#loading').hide();
                    // $('#info-aggiuntive .content').html(msg);
                }
            });
        }
        }

        function getCategorie(tipo_cat) {
            // ESTRAGGO LE CATEGORIE SELEZIONATE
            var categorie = [];

            var nCatAll = 0;
            $('#' + tipo_cat + ' .macrocategory:checked').each(function () {
                if ($('#' + tipo_cat + ' .sub_' + $(this).val() + ":not(:checked)").length == 0) {
                    categorie.push($(this).val());
                    // if ($(this).val() == "TransferServiceAndRenting") {
                    //     categorie.push("BusStop");
                    //     categorie.push("SensorSite");
                    // }
                    if ($(this).val() == "Path") {
                        categorie.pop("Path");
                        categorie.push("Cycle_paths");
                        categorie.push("Tourist_trail");
                        categorie.push("Tramline");
                    }
                    if ($(this).val() == "Area") {
                        categorie.pop("Area");
                        categorie.push("Gardens");
                        categorie.push("Green_areas");
                        categorie.push("Controlled_parking_zone");
                    }
                    // CODICE PER EVENTI NEI TRASVERSALI
                    if ($(this).val() == "HappeningNow") {
                        categorie.pop("HappeningNow");
                        categorie.push("Event");
                    }
                    nCatAll++;
                }
                else
                    $('#' + tipo_cat + ' .sub_' + $(this).val() + ":checked").each(function () {
                        categorie.push($(this).val());
                    });
            });
            if (nCatAll == $('#' + tipo_cat + ' .macrocategory').length) {
                categorie = ["Service"];
                /*if (tipo_cat == "categorie") {
                 categorie.push("BusStop");
                 categorie.push("SensorSite");
                 }else{
                 
                 if ($('#Bus').is(':checked'))
                 categorie.push($("#Bus").val());
                 if ($('#Sensor').is(':checked'))
                 categorie.push($("#Sensor").val());
                 }*/
                categorie.push("BusStop");
                categorie.push("SensorSite");
                if (tipo_cat == 'categorie_t') {
                    categorie.push("Event");
                    categorie.push("PublicTransportLine");
                }

            }
            return categorie;
        }

        function ricercaServizi(tipo_categorie, cat, limit) {

            textFilter="";
            value_type="";
            serviceModel="";

            var raggioRicerca="";
            mode = "normal";
            var tipo_cat = tipo_categorie;

            if (cat != null) {
                /*if(cat == 'TransferServiceAndRenting'){
                    var stringaCategorie = cat+";BusStop;SensorSite";
                }else{
                    var stringaCategorie = cat;
                }*/
                var stringaCategorie = cat;

                if ((cat.indexOf("BusStop") != -1) || (cat.indexOf("SensorSite") != -1)) {
                    tipo_cat = tipo_cat + ":" + $("#nResultsServizi").val();
                }
            } else {
                stringaCategorie = getCategorie(tipo_cat).join(";");
            }

            if (selezione == undefined)
                selezione = "";

            //if (tipo_categorie == "categorie")
            if ((tipo_cat.indexOf("categorie:") != -1) || tipo_cat == "categorie") {
                 raggioRicerca = $("#raggioricerca").val();
            }
            else {
                 raggioRicerca = $("#raggioricerca_t").val();
            }

            if (((selezione != '') && (selezione.indexOf('Bus Line') == -1)) || raggioRicerca == "area" || raggioRicerca == "geo") {
                if (stringaCategorie == "") {
                    alert("Select at least one category from top-right menu");
                }
                else {
                    $('#loading').show();
                    // SVUOTO LA MAPPA DAI PUNTI PRECEDENTEMENTE DISEGNATI
                    if ((selezione.indexOf("Linea Bus:") == -1) || (selezione.indexOf("Bus Line:") == -1)) {
                        svuotaLayers();
                    }
                    mostraServiziAJAX_new(stringaCategorie, selezione, coordinateSelezione, comuneChoice, limit, null, null, null, null, null, null, null, tipo_cat);
                }
            }
            else {
                alert("Attention, you did not select any resources base for research");
            }
        }

        function mostraServiziAJAX_new(categorie, selezione, coordinateSelezione, nomeComune, risultatiServizi, risultatiSensori, risultatiBus, raggioServizi, raggioSensori, raggioBus, openPins, textFilter, tipo_categoria) {
            //$('#info-aggiuntive .content').html('');

            if (tipo_categoria == undefined)
                tipo_categoria = "categorie";
            //Michela
            /*
            if(tipo_categoria == "categorie_t"){
                var countCategories = categorie.split(";");
                var loading_categories = countCategories.length;
                $('#loading').show();
            }*/
            //michela
            if(tipo_categoria == "categorie_t"){
                    document.getElementById('save_disc_t').removeAttribute('disabled','disabled');
                    document.getElementById('save_disc_t').src="img/save_enable.png";
                    document.getElementById('save_disc_t').style.cursor="pointer";    
                }else if(tipo_categoria == "categorie"){
                    document.getElementById('save_disc_regular').removeAttribute('disabled','disabled');
                    document.getElementById('save_disc_regular').src="img/save_enable.png";
                    document.getElementById('save_disc_regular').style.cursor="pointer"; 
                }else {
                    document.getElementById('saveEventSearch').removeAttribute('disabled','disabled');
                    document.getElementById('saveEventSearch').src="img/save_enable.png";
                    document.getElementById('saveEventSearch').style.cursor="pointer"; 
                }
                

            if (mode != "query" && mode != "embed") {

                if ((tipo_categoria == "categorie") || (tipo_categoria.indexOf("categorie:") != -1)) {

                    if (risultatiServizi != null) {
                        var numeroRisultatiServizi = risultatiServizi;
                    } else {
                        var numeroRisultatiServizi = $('#nResultsServizi').val();
                    }
                    //MICHELA
                    var numeroRisultatiSensori = $('#nResultsSensor').val();
                    var numeroRisultatiBus = $('#nResultsBus').val();
                    var raggioServizi = $("#raggioricerca").val();
                    var areaServizi = $("#geosearch").val();
                    var raggioSensori = raggioServizi;
                    var raggioBus = raggioServizi;
                    serviceModel=$("#serviceModel").val();
                    textFilter = $("#serviceTextFilter").val();
                    value_type = $("#valueTypeFilter").val();
                } else {
                    var numeroRisultatiServizi = $('#nResultsServizi_t').val();
                    var raggioServizi = $("#raggioricerca_t").val();
                    textFilter = $("#serviceTextFilter_t").val();
                }

                //per salvataggio query
                var raggi = [];
                raggi.push(raggioServizi, raggioSensori, raggioBus);
                var numRis = [];
                numRis.push(numeroRisultatiServizi, numeroRisultatiSensori, numeroRisultatiBus);
            }else {

                var urlParams = new URLSearchParams(window.location.search);
                serviceModel=urlParams.get('model');
                value_type=urlParams.get('value_type');

                if(serviceModel!='' || serviceModel!=undefined){
                    //coming from generated query
                    $('#serviceModel').val(serviceModel);
                    $("#serviceModel").attr("disabled", "disabled"); 
                }else{
                    serviceModel ="";
                }

                if(value_type!='' || value_type!=undefined){
                    //coming from generated query
                    $('#valueTypeFilter').val(value_type);
                    $("#valueTypeFilter").attr("disabled", "disabled"); 
                }else{
                    value_type = "";
                }
                //modificare per riprendere tutti i valori del numero risultati (servizi, sensori e bus)
                numeroRisultatiServizi = risultatiServizi;
                numeroRisultatiSensori = risultatiSensori;
                numeroRisultatiBus = risultatiBus;
                if (raggioServizi == "area")
                    raggioServizi = -1;
                $('#loading').show();
            }
            var centroRicerca;
            if (pins.length > 0)
                pins = "";
            //if (((selezione != null && selezione.indexOf("COMUNE di") == -1) && (raggioServizi == "geo" || raggioServizi=="inside")) || (coordinateSelezione != "" && undefined != coordinateSelezione && coordinateSelezione != "null" && coordinateSelezione != null)) {
            if (((selezione != null && selezione.indexOf("COMUNE di") == -1) && (raggioServizi == "geo" || raggioServizi == "inside" || raggioServizi == "area")) || (coordinateSelezione != "" && undefined != coordinateSelezione && coordinateSelezione != "null" && coordinateSelezione != null)
                                                /*|| (selezione == "" && categorie == 'BusStop')*/) {
                if (raggioServizi == "geo") {
                    centroRicerca = "geo:" + areaServizi;
                }
                else if (raggioServizi == "area") {
                    var bnds = map.getBounds()
                    centroRicerca = bnds.getSouth() + ";" + bnds.getWest() + ";" + bnds.getNorth() + ";" + bnds.getEast();
                }
                else if (coordinateSelezione == "Posizione Attuale") {
                    // SE HO RICHIESTO LA POSIZIONE ATTUALE ESTRAGGO LE COORDINATE
                    centroRicerca = GPSControl._currentLocation.lat + ";" + GPSControl._currentLocation.lng;
                }
                /*else if ((selezione.indexOf("Fermata Bus:") != -1) || (selezione.indexOf("Bus Stop:") != -1)) {
                    centroRicerca = coordinateSelezione;
                }
                else if (selezione.indexOf("Coord:") != -1 || selezione.indexOf("Numero Bus:") != -1) {
                    centroRicerca = coordinateSelezione;
                }
                else if ((selezione.indexOf("Servizio:") != -1) || (selezione.indexOf("Service:") != -1)) {
                    centroRicerca = coordinateSelezione;
                }
                else if (selezione.indexOf("point") != -1) {
                    centroRicerca = coordinateSelezione;
                }*/
                else
                centroRicerca = coordinateSelezione;

                query = saveQueryServices(centroRicerca, raggi, categorie, numRis, selezione, textFilter, serviceModel,value_type);
 
                var coord = centroRicerca.split(";");
                if (raggioServizi != "geo")
                    clickLayer.clearLayers();
                if (raggioServizi != "area" && coord.length == 2) {
                    clickLayer.addLayer(L.marker([coord[0], coord[1]]));
                    if (raggioServizi != "inside")
                        clickLayer.addLayer(L.circle([coord[0], coord[1]], raggioServizi * 1000, { className: 'circle' })).addTo(map);
                } else if (coord.length == 4 && mode == "query") {
                    clickLayer.addLayer(L.marker([(Number(coord[0]) + Number(coord[2])) / 2, (Number(coord[1]) + Number(coord[3])) / 2]));
                    clickLayer.addLayer(L.rectangle([[coord[0], coord[1]], [coord[2], coord[3]]])).addTo(map);
                } else if (coord.length == 1 && centroRicerca.startsWith("geo:") && mode == "query") {
                    $.ajax({
                        url: "ajax/json/get-geometry.jsp",
                        type: "GET",
                        async: true,
                        dataType: 'json',
                        data: {
                            label: label
                            // accessToken: MultiServiceMap.keycloak.token
                        },
                        success: function (response) {
                            var wkt = new Wkt.Wkt();
                            wkt.read(response.wkt);
                            var obj = wkt.toObject();
                            obj.addTo(clickLayer);
                            clickLayer.addTo(map);
                        }
                    });
                } else if (raggioServizi == "geo") {
                }

                var numeroServizi = 0;
                var numeroBus = 0;
                var numeroSensori = 0;
                var numEventi = 0;
                var numLineeBus = 0;
                var numTotRisultati = 0;
                var numTotServices = 0;
                var numTotBusStops = 0;
                var numTotSensors = 0;
                if (centroRicerca != null && centroRicerca.indexOf("COMUNE di") != -1) {
                    //getServices in MunicipalityMICHELA INIZIO
                    $.ajax({
                        url: ctx + "/ajax/json/get-services-in-municipality.jsp",
                        type: "GET",
                        async: true,
                        dataType: 'json',
                        data: {
                            nomeProvincia: provincia,
                            nomeComune: nomeComune,
                            categorie: categorie,
                            textFilter: textFilter,
                            numeroRisultatiServizi: numeroRisultatiServizi,
                            numeroRisultatiSensori: numeroRisultatiSensori,
                            numeroRisultatiBus: numeroRisultatiBus,
                            cat_servizi: tipo_categoria
                            // accessToken: MultiServiceMap.keycloak.token
                        },
                        success: function (msg) {
                            //console.log(msg);
                            if (mode == "JSON") {
                                $("#body").replaceWith(JSON.stringify(msg));
                            }
                            else {
                                if ($("#elencocomuni").val() != 'all') {
                                }

                                $('#loading').hide();
                                if (msg.features.length > 0) {
                                    var i = 0;
                                    var count = 0;
                                    servicesLayer = L.geoJson(msg, {
                                        pointToLayer: function (feature, latlng) {
                                            marker = showmarker(feature, latlng);
                                            return marker;
                                        },
                                        onEachFeature: function (feature, layer) {
                                            var contenutoPopup = "";
                                            var divId = feature.id + "-" + feature.properties.tipo;
                                            contenutoPopup = contenutoPopup + "<div id=\"" + divId + "\" ></div>";
                                            layer.bindPopup(contenutoPopup);
                                            if (feature.properties.serviceType == "TransferServiceAndRenting_BusStop") {
                                                numeroBus++;
                                            }
                                            else {
                                                if (feature.properties.serviceType == "TransferServiceAndRenting_SensorSite") {
                                                    numeroSensori++;
                                                }
                                                else {
                                                    numeroServizi++;
                                                }
                                            }
                                        }
                                    });

                                    if (msg.features.length >= 4000) {
                                        markers = new L.MarkerClusterGroup({ maxClusterRadius: 40, disableClusteringAtZoom: 17 });
                                        servicesLayer = markers.addLayer(servicesLayer);
                                        //$("#cluster-msg").text("piÃÂ¹ di 4000 risultati, attivato clustering");
                                        $("#cluster-msg").text("more than 4000 results, clustering enabled");
                                        $("#cluster-msg").show();
                                    }
                                    else
                                        $("#cluster-msg").hide();

                                    servicesLayer.addTo(map);
                                    if (mode == "embed") {
                                        for (i in servicesLayer._layers) {
                                            var uri = servicesLayer._layers[i].feature.properties.serviceUri;
                                            if (include(openPins, uri))
                                                servicesLayer._layers[i].openPopup();
                                        }
                                    }
                                    var markerJson = JSON.stringify(msg.features);
                                    pins = markerJson;
                                    //if (mode != "embed") {
                                    var confiniMappa = servicesLayer.getBounds();
                                    map.fitBounds(confiniMappa, { padding: [50, 50] });
                                    if (tipo_categoria == "categorie" || tipo_categoria.indexOf("categorie:") != -1) {
                                        risultatiRicerca((numeroServizi + numeroBus + numeroSensori), 0, 0, 1, null, 0, 0, 0);
                                    } else {
                                        risultatiRicerca(numeroServizi, numeroBus, numeroSensori, 1, null, 0, 0, 0);
                                    }
                                }
                                else {
                                    risultatiRicerca(0, 0, 0, 0, null, 0, 0, 0);
                                }
                            }
                            if (categorie.indexOf("Event") != -1) {
                                // numEventi = searchEvent("transverse", null, null, numeroRisultatiServizi, textFilter);
                                numEventi = searchEvent("day", null, null, numeroRisultatiServizi, textFilter);

                                if (numEventi != 0) {
                                    risultatiRicerca((numeroServizi + numEventi), numeroBus, numeroSensori, 1, null, 0, 0, 0);
                                    $("input[name=event_choice][value=day]").attr('checked', 'checked');
                                }
                            }
                        },
                        error: function (request, status, error) {
                            if ($("#elencocomuni").val() != 'all') {
                                // $.ajax({
                                //     url: "ajax/get-weather.jsp",
                                //     type: "GET",
                                //     async: true,
                                //     //dataType: 'json',
                                //     data: {
                                //         nomeComune: $("#elencocomuni").val()
                                //     },
                                //     success: function (msg) {
                                //         $('#info-aggiuntive .content').html(msg);
                                //     }
                                // });
                                var value = document.getElementById("org_selector").value;
                                if (value == "null") {
                                    // value = superServiceMapApiUrl;
                                    document.getElementById("org_selector").style.backgroundColor = "red";
                                    alert('Please, select an organization!');
                                } else {
                                    document.getElementById("org_selector").style.backgroundColor = "white";

                                if (value == superServiceMapApiUrl) {
                                    selectedorgUrl = value;
                                    sample_coord_lat = '48.3708';
                                    sample_coord_lon = '10.4589';
                                } else {
                                    seperator = value.indexOf("|");
                                    selectedorgUrl = value.substring(0, seperator);
                                    center = value.substring(seperator + 1, value.length);
                                    sample_coord_lat = center.substring(0, center.indexOf(","));
                                    sample_coord_lon = center.substring(center.indexOf(",") + 1, center.length);
                                }

                                //fammi vedere il meteo
                                $.ajax({
                                    // url: "ajax/get-weather.jsp",
                                    url: selectedorgUrl + ctx + "location/",
                                    type: "GET",
                                    async: true,
                                    headers: {'Authorization':'Bearer '+msm_access_token},
                                    //dataType: 'json',
                                    data: {
                                        position: sample_coord_lat + ';' + sample_coord_lon
                                        // accessToken: msm_access_token
                                        // nomeComune: "FIRENZE"
                                    },
                                    success: function (msg) {
                                        parameters["info"] = 'wheather';
                                        municipalityUri = msg.municipalityUri;
                                        getWeatherInfo(selectedorgUrl + ctx, municipalityUri);
                                        //$('#loading').hide();
                                        // $('#info-aggiuntive .content').html(msg);
                                    }
                                });
                            }
                            }
                            $('#loading').hide();
                            console.log(error);
                            alert('Si ÃÂ¨ verificato un errore');
                        }
                    });
                    //getServices in municipality FINE
                } else {
                    var data = {
                        selection: centroRicerca,
                        text: textFilter,
                        categories: categorie,
                        value_type: value_type,
                        maxResults: numeroRisultatiServizi,
                        model: serviceModel,
                        maxDists: raggioServizi
                        // accessToken: msm_access_token
                    }

                    for (k in data) {
                        if (data[k] == "") delete data[k];
                    }

                    $.ajax({
                        url: selectedorgUrl,
                        type: "GET",
                        async: true,
                        dataType: 'json',
                        data: data,
                        headers: {'Authorization':'Bearer '+msm_access_token},
                        success: function (msg_response) {
                            if (mode == "JSON") {
                                $("#body").html(JSON.stringify(msg_response));
                            }
                            else {
                                var nServices = 0;
                                if (msg_response.Services != undefined)
                                    nServices = msg_response.Services.features.length
                                $('#loading').hide();//TODO
                                var msg = {
                                    "fullCount": 0,
                                    "type": "FeatureCollection",
                                    "features": []
                                };

                                // conversione JSON restituito dalle API a JSON utilizzato in precedenza
                                if (msg_response != null) {
                                    if ((msg_response.BusStops != null) && (msg_response.BusStops.features.length != 0)) {
                                        msg.features = msg.features.concat(msg_response.BusStops.features);
                                        msg.fullCount = msg.fullCount + msg_response.BusStops.fullCount;
                                        if (tipo_categoria == "categorie_t") {
                                            numTotBusStops = msg_response.BusStops.fullCount;
                                        }
                                    }
                                    if ((msg_response.SensorSites != null) && (msg_response.SensorSites.features.length != 0)) {
                                        msg.features = msg.features.concat(msg_response.SensorSites.features);
                                        msg.fullCount = msg.fullCount + msg_response.SensorSites.fullCount;
                                        if (tipo_categoria == "categorie_t") {
                                            numTotSensors = msg_response.SensorSites.fullCount;
                                        }
                                    }
                                    if ((msg_response.Services != null) && (msg_response.Services.features.length != 0)) {
                                        msg.features = msg.features.concat(msg_response.Services.features);
                                        msg.fullCount = msg.fullCount + msg_response.Services.fullCount;
                                        if (tipo_categoria == "categorie_t") {
                                            numTotServices = msg_response.Services.fullCount;
                                        }
                                    }
                                }
                                for (var k = 0; k < msg.features.length; k++) {
                                    msg.features[k].id = k + 1;
                                }

                                numTotRisultati = msg.fullCount;
                                if (msg != null && msg.features.length > 0) {
                                    servicesLayer = L.geoJson(msg, {
                                        pointToLayer: function (feature, latlng) {
                                            marker = showmarker(feature, latlng);
                                            return marker;
                                        },
                                        onEachFeature: function (feature, layer) {
                                            // codice per apertura all'avvio di percorsi e aree.
                                            var contenutoPopup = "";
                                            var divId = feature.id + "-" + feature.properties.tipo;
                                            contenutoPopup = contenutoPopup + "<div id=\"" + divId + "\" ></div>";
                                            layer.bindPopup(contenutoPopup);
                                            if (feature.properties.serviceType == "TransferServiceAndRenting_BusStop") {
                                                numeroBus++;
                                            }
                                            else {
                                                if (feature.properties.serviceType == "TransferServiceAndRenting_SensorSite") {
                                                    numeroSensori++;
                                                }
                                                else {
                                                    numeroServizi++;
                                                }
                                            }
                                        }
                                    })

                                    if (msg.features.length >= 4000) {
                                        markers = new L.MarkerClusterGroup({ maxClusterRadius: 40, disableClusteringAtZoom: 17 });
                                        servicesLayer = markers.addLayer(servicesLayer);
                                        //$("#cluster-msg").text("piÃÂ¹ di 4000 risultati, attivato clustering");
                                        $("#cluster-msg").text("more than 4000 results, clustering enabled");
                                        $("#cluster-msg").show();
                                    }
                                    else
                                        $("#cluster-msg").hide();

                                    servicesLayer.addTo(map);
                                    if (mode == "embed") {
                                        for (i in servicesLayer._layers) {
                                            var uri = servicesLayer._layers[i].feature.properties.serviceUri;
                                            if (include(openPins, uri))
                                                servicesLayer._layers[i].openPopup();
                                        }
                                    }
                                    var markerJson = JSON.stringify(msg.features);
                                    pins = markerJson;

                                    if (raggioServizi != "area") {
                                        var confiniMappa = servicesLayer.getBounds();
                                        map.fitBounds(confiniMappa, { padding: [50, 50] });
                                    }
                                    //var nResults = numeroRisultatiServizi + numeroRisultatiSensori + numeroRisultatiBus;
                                    /*if (msg.features.length < nResults || nResults == 0) {
                                     risultatiRicerca(numeroServizi, numeroBus, numeroSensori, 0);
                                     }
                                     else {
                                     risultatiRicerca(numeroServizi, numeroBus, numeroSensori, 0);
                                     }*/
                                    if (tipo_categoria == "categorie" || tipo_categoria.indexOf("categorie:") != -1) {
                                        risultatiRicerca((numeroServizi + numeroBus + numeroSensori), 0, 0, 1, null, numTotRisultati, numTotBusStops, numTotSensors);
                                    } else {
                                        //risultatiRicerca(numeroServizi, numeroBus, numeroSensori, 2); //DA DECOMMENTARE QUANDO SISTEMATI TRANSVERSE SERVICE
                                        risultatiRicerca(numeroServizi, numeroBus, numeroSensori, 1, null, numTotServices, numTotBusStops, numTotSensors);
                                    }
                                }
                                else {
                                    if (categorie.indexOf("PublicTransportLine") == -1) {
                                        risultatiRicerca(0, 0, 0, 0, null, 0, 0, 0);
                                    }
                                    if (raggioServizi != "area") {
                                        map.fitBounds(clickLayer.getLayers()[1].getBounds());
                                    }
                                }
                            }
                            if (categorie.indexOf("Event") != -1) {
                                numEventi = searchEvent("day", raggioServizi, null/*centroRicerca*/, numeroRisultatiServizi, textFilter);
                                if (numEventi != 0) {
                                    risultatiRicerca((numeroServizi + numEventi), numeroBus, numeroSensori, 1, null, (numTotServices + numEventi), numTotBusStops, numTotSensors);
                                    $("input[name=event_choice][value=day]").attr('checked', 'checked');
                                }
                            }

                        },
                        error: function (request, status, error) {
                            $('#loading').hide();//TODO
                            console.log(error);
                            risultatiRicerca(0, 0, 0, 1, null, 0, 0, 0);
                            var value = document.getElementById("org_selector").value;

                            if (value == "null") {
                                // value = superServiceMapApiUrl;
                                document.getElementById("org_selector").style.backgroundColor = "red";
                                alert('Please, select an organization!');
                            } else {
                                document.getElementById("org_selector").style.backgroundColor = "white";
                                if (request.responseText.indexOf("exceeds the limit") != -1) {
                                    alert("Sorry, the query is too complex please reduce complexity.");
                                }
                            }
                        }
                    });
                }//MICHELA
                if (categorie.indexOf("PublicTransportLine") != -1) {
                    var i = 0;
                    $.ajax({
                        url: "ajax/json/get-nearTPL.jsp",
                        type: "GET",
                        async: true,
                        dataType: 'json',
                        data: {
                            centro: centroRicerca,
                            raggio: raggioServizi,
                            numLinee: numeroRisultatiServizi
                            // accessToken: MultiServiceMap.keycloak.token
                        },
                        success: function (msg) {
                            if (mode == "JSON") {
                                $("#body").html(JSON.stringify(msg));
                            }
                            else {
                                $('#loading').hide();//TODO                                                            
                                if (msg != null && msg.PublicTransportLine.features.length > 0) {
                                    numLineeBus = msg.PublicTransportLine.features.length;
                                    for (i = 0; i < msg.PublicTransportLine.features.length; i++) {
                                        var agency = msg.PublicTransportLine.features[i].properties.agency;
                                        var nomeLinea = agency + " - Line: " + msg.PublicTransportLine.features[i].properties.lineNumber + " " + msg.PublicTransportLine.features[i].properties.lineName
                                        showLinea(msg.PublicTransportLine.features[i].properties.lineNumber, msg.PublicTransportLine.features[i].properties.routeUri, msg.PublicTransportLine.features[i].properties.direction, nomeLinea, "transverse", msg.PublicTransportLine.features[i].properties.polyline, i);
                                    }

                                    //risultatiRicerca(msg.PublicTransportLine.features.length+numeroServizi, numeroBus, numeroSensori, 1);
                                    $('#resultTPL').show();
                                    var template = "{{#features}}" +
                                        "<div class=\"tplItem\" id=\"route_ATAF_{{properties.route}}\" style=\"margin-top:5px; border:1px solid #000; padding:6px; overflow:auto;\" onmouseover=\"selectRoute({{properties.routeUri}})\" onmouseout=\"deselectRoute({{properties.routeUri}})\">\n\
                                                                        <div class=\"tplName\"><b style=\"color:#B500B5;\"><b>TPL Line:</b> {{properties.lineName}}</b></div>" +
                                        "<div class=\"tplDirection\" style=\"float:left; margin-top:7px; display:block; width:85%;\"><b>Direction:</b> {{properties.direction}}<br></div></div>" +
                                        "{{/features}}";
                                    var output = Mustache.render(template, msg.PublicTransportLine);
                                    document.getElementById('listTPL').innerHTML = output;
                                    $(".circle.leaflet-clickable").css({ stroke: "#0c0", fill: "#0c0" });
                                    $('#numTPL').html(numLineeBus + " Public Transport Lines Found.");
                                    $('#numTPL').show();
                                    if (($('#msg').text().indexOf('not results') != -1) || ($('#msg').text().indexOf('alcun risultato') != -1) || numeroServizi == 0) {
                                        $('#msg').html('');
                                        $('#searchOutput').hide();
                                    }
                                } else {
                                    if (categorie == "PublicTransportLine" || (numeroServizi == 0)) {
                                        risultatiRicerca(0, 0, 0, 0, null, 0, 0, 0);
                                    }
                                }
                            }
                        }
                    });
                }
            }
            else {
                // caso tutte le fermate oppure ricerca per comune
                if (pins.length > 0)
                    pins = "";
                if (mode == "query" || mode == "embed") {
                    var nomeComune = nomeComune;
                    $('#loading').show();
                }
                else
                    var nomeComune = $("#elencocomuni").val();
                //qui devo cambiare le condizioni   

                //if (selezione == "" || (selezione != null && selezione.indexOf("COMUNE di") != -1)) {
                if ((selezione == "" && categorie != 'BusStop') || (selezione != null && selezione.indexOf("COMUNE di") != -1)) {
                    var provincia = $("#elencoprovince").val();
                    var comune = $("#elencocomuni").val();
                    query = saveQueryMunicipality(provincia, comune, categorie, numRis, selezione);
                    var numeroServizi = 0;
                    var numeroBus = 0;
                    var numeroSensori = 0;
                    var numEventi = 0;
                    $.ajax({
                        url: ctx + "/ajax/json/get-services-in-municipality.jsp",
                        type: "GET",
                        async: true,
                        dataType: 'json',
                        data: {
                            nomeProvincia: provincia,
                            nomeComune: nomeComune,
                            categorie: categorie,
                            textFilter: textFilter,
                            numeroRisultatiServizi: numeroRisultatiServizi,
                            numeroRisultatiSensori: numeroRisultatiSensori,
                            numeroRisultatiBus: numeroRisultatiBus,
                            cat_servizi: tipo_categoria
                            // accessToken: MultiServiceMap.keycloak.token
                        },
                        success: function (msg) {
                            //console.log(msg);
                            if (mode == "JSON") {
                                $("#body").replaceWith(JSON.stringify(msg));
                            }
                            else {
                                if ($("#elencocomuni").val() != 'all') {
                                    //if (selectOption.options[selectOption.options.selectedIndex].value != 'all'){
                                    /*
                                     $.ajax({
                                     url : "ajax/get-weather.jsp",
                                     type : "GET",
                                     async: true,
                                     //dataType: 'json',
                                     data : {
                                     nomeComune: $("#elencocomuni").val()
                                     },
                                     success : function(msg) {
                                     $('#info-aggiuntive .content').html(msg);
                                     }
                                     });
                                     */
                                }

                                $('#loading').hide();
                                if (msg.features.length > 0) {
                                    servicesLayer = L.geoJson(msg, {
                                        pointToLayer: function (feature, latlng) {
                                            marker = showmarker(feature, latlng);
                                            return marker;
                                        },
                                        onEachFeature: function (feature, layer) {
                                            var contenutoPopup = "";
                                            var divId = feature.id + "-" + feature.properties.tipo;
                                            // X TEMPI DI CARICAMENTO INFO SCHEDA ALL'APERTURA DEL POPUP LUNGHI, VISUALIZZARE NOME, LOD E TIPOLOGIA DI SERVIZIO
                                            /*if (feature.properties.nome != null && feature.properties.nome != "")
                                             contenutoPopup = "<h3>" + feature.properties.nome + "</h3>";
                                             else {
                                             if (feature.properties.identifier != null && feature.properties.identifier != "")
                                             contenutoPopup = "<h3>" + feature.properties.identifier + "</h3>";
                                             }
                                             contenutoPopup = contenutoPopup + "<a href='" + logEndPoint + feature.properties.serviceUri + "' title='Linked Open Graph' target='_blank'>LINKED OPEN GRAPH</a><br />";
                                             contenutoPopup = contenutoPopup + "<b>Tipologia: </b>" + feature.properties.category +" - "+ feature.properties.subCategory + "<br />";*/
                                            contenutoPopup = contenutoPopup + "<div id=\"" + divId + "\" ></div>";
                                            layer.bindPopup(contenutoPopup);
                                            if (feature.properties.serviceType == "TransferServiceAndRenting_BusStop") {
                                                numeroBus++;
                                            }
                                            else {
                                                if (feature.properties.serviceType == "TransferServiceAndRenting_SensorSite") {
                                                    numeroSensori++;
                                                }
                                                else {
                                                    numeroServizi++;
                                                }
                                            }

                                        }
                                    });

                                    if (msg.features.length >= 4000) {
                                        markers = new L.MarkerClusterGroup({ maxClusterRadius: 40, disableClusteringAtZoom: 17 });
                                        servicesLayer = markers.addLayer(servicesLayer);
                                        //$("#cluster-msg").text("piÃÂ¹ di 4000 risultati, attivato clustering");
                                        $("#cluster-msg").text("more than 4000 results, clustering enabled");
                                        $("#cluster-msg").show();
                                    }
                                    else
                                        $("#cluster-msg").hide();

                                    servicesLayer.addTo(map);
                                    if (mode == "embed") {
                                        for (i in servicesLayer._layers) {
                                            var uri = servicesLayer._layers[i].feature.properties.serviceUri;
                                            if (include(openPins, uri))
                                                servicesLayer._layers[i].openPopup();
                                        }
                                    }
                                    var markerJson = JSON.stringify(msg.features);
                                    pins = markerJson;
                                    //if (mode != "embed") {
                                    var confiniMappa = servicesLayer.getBounds();
                                    map.fitBounds(confiniMappa, { padding: [50, 50] });
                                    if (tipo_categoria == "categorie" || tipo_categoria.indexOf("categorie:") != -1) {
                                        risultatiRicerca((numeroServizi + numeroBus + numeroSensori), 0, 0, 1, null, 0, 0, 0);
                                    } else {
                                        risultatiRicerca(numeroServizi, numeroBus, numeroSensori, 1, null, 0, 0, 0);
                                    }
                                }
                                else {
                                    risultatiRicerca(0, 0, 0, 0, null, 0, 0, 0);
                                }
                            }
                            if (categorie.indexOf("Event") != -1) {
                                numEventi = searchEvent("day", null, null, numeroRisultatiServizi, textFilter);
                                if (numEventi != 0) {
                                    risultatiRicerca((numeroServizi + numEventi), numeroBus, numeroSensori, 1, null, 0, 0, 0);
                                    $("input[name=event_choice][value=day]").attr('checked', 'checked');
                                }
                            }
                        },
                        error: function (request, status, error) {
                            if ($("#elencocomuni").val() != 'all') {
                                // $.ajax({
                                //     url: "ajax/get-weather.jsp",
                                //     type: "GET",
                                //     async: true,
                                //     //dataType: 'json',
                                //     data: {
                                //         nomeComune: $("#elencocomuni").val()
                                //     },
                                //     success: function (msg) {
                                //         $('#info-aggiuntive .content').html(msg);
                                //     }
                                // });
                                var value = document.getElementById("org_selector").value;
                                if (value == "null") {
                                    // value = superServiceMapApiUrl;
                                    document.getElementById("org_selector").style.backgroundColor = "lightpink";
                                    alert('Please, select an organization!');
                                } else {
                                    document.getElementById("org_selector").style.backgroundColor = "white";
                                

                                if (value == superServiceMapApiUrl) {
                                    selectedorgUrl = value;
                                    sample_coord_lat = '48.3708';
                                    sample_coord_lon = '10.4589';
                                } else {
                                    seperator = value.indexOf("|");
                                    selectedorgUrl = value.substring(0, seperator);
                                    center = value.substring(seperator + 1, value.length);
                                    sample_coord_lat = center.substring(0, center.indexOf(","));
                                    sample_coord_lon = center.substring(center.indexOf(",") + 1, center.length);
                                }

                                //fammi vedere il meteo
                                $.ajax({
                                    // url: "ajax/get-weather.jsp",
                                    url: selectedorgUrl + ctx + "location/",
                                    type: "GET",
                                    async: true,
                                    headers: {'Authorization':'Bearer '+msm_access_token},
                                    //dataType: 'json',
                                    data: {
                                        position: sample_coord_lat + ';' + sample_coord_lon
                                        // accessToken: msm_access_token
                                        // nomeComune: "FIRENZE"
                                    },
                                    success: function (msg) {
                                        municipalityUri = msg.municipalityUri;
                                        getWeatherInfo(selectedorgUrl + ctx, municipalityUri);
                                        //$('#loading').hide();
                                        // $('#info-aggiuntive .content').html(msg);
                                    }
                                });
                            }
                            }
                            $('#loading').hide();
                            console.log(error);
                            alert('Si ÃÂ¨ verificato un errore');
                        }
                    });
                }/*
                                            else if(selezione == "" && categorie == 'BusStop'){
                                                  risultatiRicerca(0, 0, 0, 0, null, 0, 0, 0);//DA CAMBIARE
                                            }*/

                if (selezione != null && (selezione.indexOf("Linea Bus:") != -1 || selezione.indexOf("Bus Line:") != -1)) {
                    $.ajax({
                        url: "ajax/json/get-services-near-stops.jsp",
                        type: "GET",
                        async: true,
                        dataType: 'json',
                        data: {
                            nomeLinea: $('#elencolinee')[0].options[$('#elencolinee')[0].options.selectedIndex].value,
                            raggio: 100,
                            categorie: categorie,
                            numerorisultati: 100
                        },
                        success: function (msg) {
                            $('#loading').hide();
                            var i = 0;
                            if (msg.features.length > 0) {
                                servicesLayer = L.geoJson(msg, {
                                    pointToLayer: function (feature, latlng) {
                                        marker = showmarker(feature, latlng);
                                        return marker;
                                    },
                                    onEachFeature: function (feature, layer) {
                                        var divId = feature.id + "-" + feature.properties.tipo;
                                        var divLinee = divId + "-linee";
                                        // contenutoPopup="<div id=\""+divId+"\" >";
                                        if (feature.properties.tipo == "fermata")
                                            contenutoPopup = "<h3> BUS STOP: " + feature.properties.name + "</h3>";
                                        else
                                            contenutoPopup = "<h3>" + feature.properties.name + "</h3>";
                                        contenutoPopup = contenutoPopup + "Serviceuri: <a href='" + logEndPoint + feature.properties.serviceUri + "' title='Linked Open Graph' target='_blank'>" + feature.properties.serviceUri + "</a><br />";
                                        contenutoPopup = contenutoPopup + "Tipology: " + feature.properties.tipo + "<br />";
                                        if (feature.properties.email != "")
                                            contenutoPopup = contenutoPopup + "Email: " + feature.properties.email + "<br />";
                                        if (feature.properties.indirizzo != "")
                                            contenutoPopup = contenutoPopup + "Address: " + feature.properties.indirizzo + "<br />";
                                        if (feature.properties.note != "")
                                            contenutoPopup = contenutoPopup + "Note: " + feature.properties.note + "<br />";
                                        contenutoPopup += "<div id=\"" + divLinee + "\" ></div>";
                                        contenutoPopup = contenutoPopup + "<div id=\"" + divId + "\" ></div>";
                                        layer.bindPopup(contenutoPopup);
                                    }
                                }).addTo(map);
                                var markerJson = JSON.stringify(msg.features);
                                pins = markerJson;
                                var confiniMappa = servicesLayer.getBounds();
                                map.fitBounds(confiniMappa, { padding: [50, 50] });
                                var nSer = (msg.features.length);
                                risultatiRicerca(msg.features.length, 0, 0, 1, null, 0, 0, 0);
                            }
                            else {
                                risultatiRicerca(0, 0, 0, 0, null, 0, 0, 0);
                            }
                        },
                        error: function (request, status, error) {
                            $('#loading').hide();
                            console.log(error);
                            alert('Si ÃÂ¨ verificato un errore');
                        }
                    });
                }
            }
        }
        $('.gps-button').click(function () {
            if (GPSControl._isActive == true) {
                selezione = 'Posizione Attuale';
                $('#selezione').html(selezione);
                coordinateSelezione = "Posizione Attuale";
                $('#raggioricerca').prop('disabled', false);
                $('#raggioricerca_t').prop('disabled', false);
                $('#numerorisultati').prop('disabled', false);
                $('#PublicTransportLine').prop('disabled', false);
            }
        });
        $('#info img').click(function () {
            if ($("#info").hasClass("active") == false) {
                $('#info').addClass("active");
                selezioneAttiva = true;
            }
            else {
                $('#info').removeClass("active");
                selezioneAttiva = false;
            }
        });
        $('#choosePosition').click(function () {
            if ($("#choosePosition").hasClass("active") == false) {
                $('#choosePosition').addClass("active");
                selezioneAttiva = true;
            }
            else {
                $('#choosePosition').removeClass("active");
                selezioneAttiva = false;
                clickLayer.clearLayers();
            }
        });



    </script>

    <div id="overMap"></div>
    <div id="ui-datepicker-div" class="ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all">
    </div>
    <ul class="ui-autocomplete ui-front ui-menu ui-widget ui-widget-content" id="ui-id-8" tabindex="0"
        style="display: none;"></ul>
    <span role="status" aria-live="assertive" aria-relevant="additions" class="ui-helper-hidden-accessible"></span>
</body>

</html>